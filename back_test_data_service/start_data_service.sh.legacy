#!/bin/bash

set -euo pipefail

echo "🚀 股票数据服务启动器 (Mac Mini)"
echo "================================"

# 选择Python命令
if command -v python3.11 &> /dev/null; then
    PYTHON=python3.11
else
    PYTHON=python3
fi

# 校验Python可用
if ! command -v "$PYTHON" &> /dev/null; then
    echo "❌ 错误: 未找到$PYTHON，请先安装Python 3"
    exit 1
fi

# 检查依赖文件
echo "📦 检查依赖..."
if [ ! -f "requirements.txt" ]; then
    echo "❌ 错误: 未找到requirements.txt文件"
    exit 1
fi

# 创建/激活虚拟环境
if [ ! -d "venv" ]; then
    echo "🔧 创建虚拟环境 (venv) ..."
    "$PYTHON" -m venv venv
fi

source venv/bin/activate
PYTHON=python

# 升级pip
echo "⬆️  升级pip..."
"$PYTHON" -m pip install --upgrade pip || true

# 安装构建工具
echo "🛠  安装构建工具(setuptools, wheel)..."
"$PYTHON" -m pip install --upgrade setuptools wheel || true

# 安装依赖
echo "📥 安装Python依赖..."
if ! "$PYTHON" -m pip install --no-cache-dir -r requirements.txt; then
    echo "❌ 依赖安装失败，请检查网络连接和Python环境"
    exit 1
fi

# 创建日志目录
echo "📝 创建日志目录..."
mkdir -p logs

# 启动服务
echo ""
echo "🔧 选择启动的服务类型:"
echo "  1) 数据获取和同步服务 (定时任务)"
echo "  2) 数据状态API服务 (REST API)"
echo "  3) 同时启动两者"
echo ""

read -p "请选择 (1/2/3): " choice

case $choice in
    1)
        echo "🚀 启动数据获取和同步服务..."
        echo "📋 日志文件: logs/data_service.log"
        echo ""
        exec "$PYTHON" scripts/run_data_service.py
        ;;
    2)
        echo "🚀 启动数据状态API服务..."
        echo "📋 日志文件: logs/data_api.log"
        echo "🌐 API服务地址: http://localhost:5002"
        echo ""
        exec "$PYTHON" scripts/run_data_api.py
        ;;
    3)
        echo "🚀 同时启动数据获取和API服务..."
        echo "📋 数据服务日志: logs/data_service.log"
        echo "📋 API服务日志: logs/data_api.log"
        echo "🌐 API服务地址: http://localhost:5002"
        echo ""

        # 后台启动数据获取服务
        nohup "$PYTHON" scripts/run_data_service.py > logs/data_service.log 2>&1 &
        DATA_SERVICE_PID=$!

        # 等待一下让数据服务启动
        sleep 2

        # 前台启动API服务（作为主进程）
        "$PYTHON" scripts/run_data_api.py &
        API_SERVICE_PID=$!

        # 等待API服务启动
        sleep 2

        echo "✅ 数据服务已启动 (PID: $DATA_SERVICE_PID)"
        echo "✅ API服务已启动 (PID: $API_SERVICE_PID)"
        echo ""
        echo "🔄 服务状态检查:"
        echo "  ps aux | grep run_data_service  # 检查数据服务"
        echo "  ps aux | grep run_data_api     # 检查API服务"
        echo "  curl http://localhost:5002/api/data/health  # 检查API健康状态"
        echo ""
        echo "🛑 停止服务:"
        echo "  kill $DATA_SERVICE_PID $API_SERVICE_PID"
        echo ""

        # 等待用户中断
        trap "echo '🛑 正在停止服务...'; kill $DATA_SERVICE_PID $API_SERVICE_PID 2>/dev/null; exit 0" INT TERM
        wait
        ;;
    *)
        echo "❌ 无效选择，请重新运行脚本"
        exit 1
        ;;
esac
