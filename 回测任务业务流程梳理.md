# 回测任务业务流程梳理

## 一、整体架构概览

### 1.1 技术栈
- **后端**: FastAPI + SQLAlchemy + WebSocket
- **前端**: Next.js + React + TypeScript + HeroUI
- **数据库**: PostgreSQL (任务、结果存储)
- **实时通信**: WebSocket (进度推送)

### 1.2 核心模块
```
后端模块:
├── API层 (backend/app/api/v1/)
│   ├── tasks.py                    # 任务管理API
│   ├── backtest_websocket.py       # WebSocket端点
│   └── dependencies.py             # 任务执行依赖
├── 服务层 (backend/app/services/backtest/)
│   ├── backtest_executor.py        # 回测执行器
│   ├── backtest_progress_monitor.py # 进度监控
│   └── backtest_engine.py          # 回测引擎
├── 数据层 (backend/app/repositories/)
│   └── task_repository.py          # 任务数据仓库
└── 模型层 (backend/app/models/)
    └── task_models.py              # 数据模型

前端模块:
├── 页面 (frontend/src/app/tasks/)
│   └── [id]/page.tsx               # 任务详情页
├── 服务 (frontend/src/services/)
│   ├── backtestService.ts          # 回测服务
│   ├── BacktestProgressWebSocket.ts # WebSocket客户端
│   └── api.ts                      # API封装
└── 组件 (frontend/src/components/backtest/)
    ├── BacktestProgressMonitor.tsx  # 进度监控组件
    ├── BacktestOverview.tsx         # 概览组件
    └── InteractiveChartsContainer.tsx # 图表容器
```

## 二、回测任务创建流程

### 2.1 前端发起请求

**位置**: 前端任务创建表单 → `TaskService.createTask()`

**请求数据结构**:
```typescript
{
  task_name: string,           // 任务名称
  task_type: "backtest",       // 任务类型
  stock_codes: string[],       // 股票代码列表
  backtest_config: {
    strategy_name: string,     // 策略名称
    start_date: string,        // 开始日期
    end_date: string,          // 结束日期
    initial_cash: number,      // 初始资金
    commission_rate: number,   // 手续费率
    slippage_rate: number      // 滑点率
  }
}
```

### 2.2 后端接收并创建任务

**API端点**: `POST /api/v1/tasks`  
**处理文件**: `backend/app/api/v1/tasks.py::create_task()`

**核心流程**:
```python
1. 解析请求参数
   - 确定任务类型 (task_type = "backtest")
   - 构建任务配置 (config)

2. 创建任务记录
   task = task_repository.create_task(
       task_name=request.task_name,
       task_type=TaskType.BACKTEST,
       user_id="default_user",
       config=config
   )
   # 数据库插入: tasks表
   # 状态: CREATED, 进度: 0%

3. 加入后台执行队列
   background_tasks.add_task(
       execute_backtest_task_simple, 
       task.task_id
   )
```


### 2.3 数据库模型

**任务表 (tasks)**:
```python
- task_id: String (主键, UUID)
- task_name: String (任务名称)
- task_type: String ("backtest")
- status: String (CREATED/RUNNING/COMPLETED/FAILED)
- user_id: String (用户ID)
- config: JSON (任务配置)
- progress: Float (0-100)
- result: JSON (回测结果)
- error_message: Text (错误信息)
- created_at: DateTime
- started_at: DateTime
- completed_at: DateTime
```

## 三、回测任务执行流程

### 3.1 后台任务启动

**执行函数**: `backend/app/api/v1/dependencies.py::execute_backtest_task_simple()`

**执行步骤**:
```python
1. 获取任务记录
   task = task_repository.get_task_by_id(task_id)

2. 更新状态为 RUNNING
   task_repository.update_task_status(
       task_id=task_id,
       status=TaskStatus.RUNNING,
       progress=10.0
   )

3. 解析配置参数
   - stock_codes: 股票代码列表
   - strategy_name: 策略名称
   - start_date/end_date: 回测时间范围
   - initial_cash: 初始资金
   - commission_rate: 手续费率
   - slippage_rate: 滑点率

4. 创建回测执行器
   executor = BacktestExecutor(data_dir="backend/data")
   
5. 创建回测配置
   backtest_config = BacktestConfig(
       initial_cash=initial_cash,
       commission_rate=commission_rate,
       slippage_rate=slippage_rate
   )
```


### 3.2 回测执行核心流程

**执行器**: `backend/app/services/backtest/backtest_executor.py::BacktestExecutor.run_backtest()`

**详细步骤**:

#### 阶段1: 初始化 (0-10%)
```python
1. 生成回测ID
   backtest_id = f"bt_{timestamp}_{hash(stock_codes)}"

2. 启动进度监控
   await backtest_progress_monitor.start_backtest_monitoring(
       task_id=task_id,
       backtest_id=backtest_id
   )

3. 更新阶段: initialization (完成)
```

#### 阶段2: 数据加载 (10-25%)
```python
1. 更新阶段: data_loading (运行中)

2. 加载股票数据
   data_loader = DataLoader(data_dir)
   stock_data = data_loader.load_multiple_stocks(
       stock_codes, start_date, end_date
   )
   # 从 backend/data/ 目录加载CSV文件
   # 使用 StockDataLoader 统一加载器

3. 验证数据完整性
   - 检查必需列: open, high, low, close, volume
   - 验证数据量是否充足

4. 更新阶段: data_loading (完成)
```

#### 阶段3: 策略设置 (25-30%)
```python
1. 更新阶段: strategy_setup (运行中)

2. 创建交易策略
   strategy = StrategyFactory.create_strategy(
       strategy_name, 
       strategy_config
   )
   # 支持的策略: default_strategy, ma_crossover等

3. 创建组合管理器
   portfolio_manager = PortfolioManager(backtest_config)
   # 初始化现金、持仓、交易记录

4. 更新阶段: strategy_setup (完成)
```


#### 阶段4: 回测执行 (30-90%) - 核心阶段
```python
1. 更新阶段: backtest_execution (运行中)

2. 获取交易日历
   trading_dates = _get_trading_calendar(stock_data, start_date, end_date)
   # 合并所有股票的交易日期并排序

3. 主循环 - 逐日回测
   for i, current_date in enumerate(trading_dates):
       
       a. 获取当前价格
          current_prices = {
              stock_code: data.loc[current_date, 'close']
              for stock_code, data in stock_data.items()
          }
       
       b. 生成交易信号
          for stock_code, data in stock_data.items():
              historical_data = data[data.index <= current_date]
              signals = strategy.generate_signals(
                  historical_data, 
                  current_date
              )
              # 策略根据历史数据生成买卖信号
       
       c. 验证并执行信号
          for signal in all_signals:
              if strategy.validate_signal(signal, ...):
                  trade = portfolio_manager.execute_signal(
                      signal, 
                  