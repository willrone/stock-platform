---
name: 回测信号记录和图表优化
overview: 添加信号记录页签展示、在图表上可选显示信号和交易操作标记，并修复价格走势图表的涨跌颜色（红色涨、绿色跌）
todos:
  - id: "1"
    content: 后端：创建SignalRecord数据库模型和迁移
    status: pending
  - id: "2"
    content: 后端：在回测执行器中保存信号记录到数据库
    status: pending
  - id: "3"
    content: 后端：在Repository中添加信号记录查询方法
    status: pending
  - id: "4"
    content: 后端：添加信号记录API端点
    status: pending
  - id: "5"
    content: 前端：创建SignalHistoryTable组件
    status: pending
  - id: "6"
    content: 前端：在BacktestService中添加信号API调用
    status: pending
  - id: "7"
    content: 前端：在任务详情页添加信号记录页签
    status: pending
  - id: "8"
    content: 前端：修复TradingViewChart的涨跌颜色（红色涨、绿色跌）
    status: pending
  - id: "9"
    content: 前端：在TradingViewChart中添加信号标记和显示控制
    status: pending
---

# 回测信号记录和图表优化计划

## 需求分析

1. **信号记录展示**：目前回测结果只有交易记录，需要添加信号记录页签
2. **图表标记**：价格走势图上需要可选显示信号和买入卖出操作
3. **颜色修复**：价格走势图表的涨跌颜色需要修正（红色涨、绿色跌）

## 实现方案

### 1. 后端：信号记录存储和API

#### 1.1 创建信号记录数据库模型

**文件**: `backend/app/models/backtest_detailed_models.py`

- 添加 `SignalRecord` 模型类，包含字段：
  - `id`, `task_id`, `backtest_id`, `signal_id`
  - `stock_code`, `stock_name`
  - `signal_type` (BUY/SELL)
  - `timestamp`, `price`, `strength`
  - `reason`, `metadata` (JSON)
  - `executed` (是否被执行)
  - `created_at`

#### 1.2 更新数据库迁移

**文件**: `backend/migrations/add_backtest_detailed_tables.py`

- 添加 `create_signal_records_table` 方法
- 创建 `signal_records` 表和索引

#### 1.3 更新回测执行器保存信号

**文件**: `backend/app/services/backtest/backtest_executor.py`

- 在 `_execute_backtest_loop` 方法中，生成信号后保存到数据库
- 使用 `BacktestDetailedRepository` 保存信号记录
- 标记信号是否被执行（如果对应的交易记录存在）

#### 1.4 更新Repository添加信号查询方法

**文件**: `backend/app/repositories/backtest_detailed_repository.py`

- 添加 `save_signal_record` 方法
- 添加 `get_signal_records` 方法（支持分页、筛选、排序）
- 添加 `get_signal_records_count` 方法
- 添加 `get_signal_statistics` 方法

#### 1.5 添加信号记录API端点

**文件**: `backend/app/api/v1/backtest_detailed.py`

- 添加 `GET /{task_id}/signal-records` 端点（类似交易记录接口）
- 添加 `GET /{task_id}/signal-statistics` 端点

### 2. 前端：信号记录页签和图表优化

#### 2.1 创建信号记录表格组件

**文件**: `frontend/src/components/backtest/SignalHistoryTable.tsx`

- 参考 `TradeHistoryTable.tsx` 的结构
- 显示信号记录：时间、股票代码、信号类型、价格、强度、原因、是否执行
- 支持分页、排序、筛选、搜索
- 显示信号统计信息

#### 2.2 更新BacktestService添加信号API调用

**文件**: `frontend/src/services/backtestService.ts`

- 添加 `SignalRecord` 接口定义
- 添加 `SignalStatistics` 接口定义
- 添加 `getSignalRecords` 方法
- 添加 `getSignalStatistics` 方法

#### 2.3 在任务详情页添加信号记录页签

**文件**: `frontend/src/app/tasks/[id]/page.tsx`

- 在回测任务的Tabs中添加"信号记录"页签（在"交易记录"之后）
- 使用 `SignalHistoryTable` 组件

#### 2.4 修复TradingViewChart颜色问题

**文件**: `frontend/src/components/charts/TradingViewChart.tsx`

- 修改K线图颜色配置：
  - `upColor: '#ef5350'` (红色，上涨)
  - `downColor: '#26a69a'` (绿色，下跌)
- 修改成交量颜色逻辑：
  - 上涨时使用红色，下跌时使用绿色

#### 2.5 在TradingViewChart中添加信号标记

**文件**: `frontend/src/components/charts/TradingViewChart.tsx`

- 添加 `signals` prop（类型：信号记录数组）
- 添加 `showSignals` 和 `showTrades` 状态控制显示
- 在图表上添加信号标记（使用不同的形状/颜色区分信号和交易）
- 添加切换按钮控制显示/隐藏信号和交易标记

#### 2.6 更新InteractiveChartsContainer传递信号数据

**文件**: `frontend/src/components/charts/InteractiveChartsContainer.tsx`

- 加载信号记录数据
- 将信号数据传递给 `TradingViewChart` 组件
- 添加显示控制选项

## 数据流程

```
回测执行器生成信号
    ↓
保存信号记录到数据库 (signal_records表)
    ↓
前端API获取信号记录
    ↓
信号记录页签展示
    ↓
图表组件接收信号数据
    ↓
在价格走势图上标记信号点
```

## 技术细节

### 信号标记样式

- 买入信号：绿色圆点或向上箭头（在K线下方）
- 卖出信号：红色圆点或向下箭头（在K线上方）
- 已执行信号：实心标记
- 未执行信号：空心标记或不同透明度

### 颜色规范

- 上涨（涨）：红色 `#ef5350`
- 下跌（跌）：绿色 `#26a69a`

## 文件清单

### 后端文件

1. `backend/app/models/backtest_detailed_models.py` - 添加SignalRecord模型
2. `backend/migrations/add_backtest_detailed_tables.py` - 添加信号表迁移
3. `backend/app/services/backtest/backtest_executor.py` - 保存信号记录
4. `backend/app/repositories/backtest_detailed_repository.py` - 信号查询方法
5. `backend/app/api/v1/backtest_detailed.py` - 信号记录API端点

### 前端文件

1. `frontend/src/components/backtest/SignalHistoryTable.tsx` - 信号记录表格组件（新建）
2. `frontend/src/services/backtestService.ts` - 信号API调用
3. `frontend/src/app/tasks/[id]/page.tsx` - 添加信号记录页签
4. `frontend/src/components/charts/TradingViewChart.tsx` - 修复颜色、添加信号标记
5. `frontend/src/components/charts/InteractiveChartsContainer.tsx` - 传递信号数据

## 注意事项

1. 信号记录需要在回测执行时保存，对于历史回测任务可能没有信号数据
2. 图表标记需要区分信号和交易，使用不同的视觉样式
3. 颜色修改需要确保所有相关图表组件都更新（K线图、成交量等）
4. 信号记录查询需要考虑性能，添加适当的索引