# 实施计划: 服务重构

## 概述

将 `backend/app/services` 目录下的 28 个服务文件按功能模块重新组织，创建 6 个功能模块，每个模块包含相关的服务文件，并保持向后兼容性。

## 任务

- [x] 1. 创建模块目录结构
  - 创建 6 个功能模块目录
  - 为每个模块创建 `__init__.py` 文件
  - _需求: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 2. 重构数据管理模块
  - [x] 2.1 移动数据相关服务文件到 `data/` 目录
    - 移动 `data_service.py`, `data_service_simple.py`, `data_sync_engine.py`
    - 移动 `data_validator.py`, `data_lifecycle.py`, `parquet_manager.py`, `stream_processor.py`
    - _需求: 1.1, 1.2_

  - [ ]* 2.2 为数据模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 1.2**

  - [x] 2.3 创建数据模块的 `__init__.py` 导出接口
    - 导出所有数据服务的公共类
    - 添加模块文档字符串
    - _需求: 1.3_

  - [ ]* 2.4 为数据模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 1.3_

- [x] 3. 重构模型管理模块
  - [x] 3.1 移动模型相关服务文件到 `models/` 目录
    - 移动 `model_training_service.py`, `model_training.py`, `model_storage.py`
    - 移动 `model_deployment_service.py`, `model_evaluation.py`, `advanced_training.py`, `modern_models.py`
    - _需求: 2.1, 2.2_

  - [ ]* 3.2 为模型模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 2.2**

  - [x] 3.3 创建模型模块的 `__init__.py` 导出接口
    - 导出所有模型服务的公共类
    - 添加模块文档字符串
    - _需求: 2.3_

  - [ ]* 3.4 为模型模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 2.3_

- [x] 4. 重构预测引擎模块
  - [x] 4.1 移动预测相关服务文件到 `prediction/` 目录
    - 移动 `prediction_engine.py`, `prediction_fallback.py`, `risk_assessment.py`
    - 移动 `feature_extractor.py`, `technical_indicators.py`
    - _需求: 3.1, 3.2_

  - [ ]* 4.2 为预测模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 3.2**

  - [x] 4.3 创建预测模块的 `__init__.py` 导出接口
    - 导出所有预测服务的公共类
    - 添加模块文档字符串
    - _需求: 3.3_

  - [ ]* 4.4 为预测模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 3.3_

- [x] 5. 重构回测引擎模块
  - [x] 5.1 移动回测相关服务文件到 `backtest/` 目录
    - 移动 `backtest_engine.py`, `backtest_executor.py`
    - _需求: 4.1, 4.2_

  - [ ]* 5.2 为回测模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 4.2**

  - [x] 5.3 创建回测模块的 `__init__.py` 导出接口
    - 导出所有回测服务的公共类
    - 添加模块文档字符串
    - _需求: 4.3_

  - [ ]* 5.4 为回测模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 4.3_

- [x] 6. 重构任务管理模块
  - [x] 6.1 移动任务相关服务文件到 `tasks/` 目录
    - 移动 `task_manager.py`, `task_queue.py`, `task_execution_engine.py`, `task_notification_service.py`
    - _需求: 5.1, 5.2_

  - [ ]* 6.2 为任务模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 5.2**

  - [x] 6.3 创建任务模块的 `__init__.py` 导出接口
    - 导出所有任务服务的公共类
    - 添加模块文档字符串
    - _需求: 5.3_

  - [ ]* 6.4 为任务模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 5.3_

- [x] 7. 重构基础设施模块
  - [x] 7.1 移动基础设施相关服务文件到 `infrastructure/` 目录
    - 移动 `cache_service.py`, `connection_pool.py`, `monitoring_service.py`
    - 移动 `enhanced_logger.py`, `metrics_collector.py`, `websocket_manager.py`
    - _需求: 6.1, 6.2_

  - [ ]* 7.2 为基础设施模块编写属性测试
    - **属性 2: 模块完整性**
    - **验证: 需求 6.2**

  - [x] 7.3 创建基础设施模块的 `__init__.py` 导出接口
    - 导出所有基础设施服务的公共类
    - 添加模块文档字符串
    - _需求: 6.3_

  - [ ]* 7.4 为基础设施模块编写单元测试
    - 测试模块导入和导出
    - 测试文件组织结构
    - _需求: 6.3_

- [x] 8. 检查点 - 确保所有模块创建完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 9. 实现向后兼容性
  - [x] 9.1 更新主 `services/__init__.py` 文件
    - 从各个子模块重新导出所有服务
    - 添加弃用警告
    - _需求: 7.1, 7.2, 7.4_

  - [ ]* 9.2 为向后兼容性编写属性测试
    - **属性 1: 向后兼容性保证**
    - **验证: 需求 1.4, 2.4, 3.4, 4.4, 5.4, 6.4, 7.1**

  - [ ]* 9.3 为向后兼容性编写单元测试
    - 测试所有现有导入语句仍然有效
    - 测试弃用警告正确显示
    - _需求: 7.3, 7.4_

- [x] 10. 更新测试文件
  - [x] 10.1 分析现有测试文件中的导入语句
    - 扫描所有测试文件，识别需要更新的导入
    - _需求: 8.2_

  - [x] 10.2 更新测试文件导入语句
    - 将测试文件中的导入更新为新的模块路径
    - 确保所有测试仍然通过
    - _需求: 8.2_

- [x] 11. 创建文档
  - [x] 11.1 为每个模块创建 README.md 文档
    - 说明每个模块的职责和包含的服务
    - 提供使用示例
    - _需求: 8.1_

  - [x] 11.2 创建迁移指南
    - 说明如何从旧导入切换到新导入
    - 提供迁移脚本或工具
    - _需求: 8.3_

  - [x] 11.3 更新代码注释
    - 在代码中添加模块职责和依赖关系的注释
    - _需求: 8.4_

- [x] 12. 最终检查点 - 确保所有测试通过
  - 运行完整的测试套件
  - 验证向后兼容性
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以实现更快的 MVP
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况