# 数据同步API修复规范

## 项目背景
股票预测平台的数据同步功能出现422错误，需要修复API接口和远程数据服务的集成问题。

## 当前状态
- ✅ **422错误已修复** - 后端API现在可以正确接受JSON请求体格式
- ❌ **远程数据服务404错误** - 新添加的API端点需要重启服务才能生效
- ✅ **本地数据降级策略** - 本地数据加载功能正常工作

## 问题分析

### 1. 已解决的问题
- **API格式不匹配**: 修改了`sync_data_from_remote`函数，从查询参数改为接受JSON请求体
- **数据模型扩展**: 扩展了`DataSyncRequest`模型，支持更多同步选项
- **本地数据降级**: 实现了完整的本地数据降级策略

### 2. 待解决的问题
- **远程服务API端点**: 新添加的`/api/data/stock/{stock_code}/daily`端点需要服务重启
- **服务重启流程**: 需要安全地重启远程数据服务而不影响其他功能

## 用户故事

### 故事1: 数据同步API正常工作
**作为** 系统用户  
**我希望** 数据同步API能够正常接受请求并返回正确结果  
**以便** 我可以同步股票数据到本地存储  

**验收标准:**
- [ ] POST `/api/v1/data/sync` 接受JSON请求体格式
- [ ] 返回200状态码而不是422错误
- [ ] 能够处理单只或多只股票的同步请求
- [ ] 提供详细的同步结果信息

### 故事2: 远程数据服务API端点可用
**作为** 后端服务  
**我希望** 能够从远程数据服务获取股票数据  
**以便** 我可以为用户提供最新的股票信息  

**验收标准:**
- [ ] GET `/api/data/stock/{stock_code}/daily` 端点返回200状态码
- [ ] 支持start_date和end_date查询参数
- [ ] 返回正确格式的股票数据
- [ ] 处理无效股票代码和日期范围

### 故事3: 降级策略正常工作
**作为** 系统  
**我希望** 在远程服务不可用时能够使用本地数据  
**以便** 保证服务的可用性和用户体验  

**验收标准:**
- [x] 远程服务不可用时自动切换到本地数据
- [x] 本地数据加载功能正常工作
- [x] 提供清晰的降级策略日志信息
- [x] 缓存机制正常工作

## 技术要求

### API接口要求
1. **请求格式**: 支持JSON请求体，包含以下字段：
   - `stock_codes`: 股票代码列表
   - `start_date`: 开始日期（可选）
   - `end_date`: 结束日期（可选）
   - `force_update`: 强制更新标志（可选）
   - `sync_mode`: 同步模式（可选）
   - `max_concurrent`: 最大并发数（可选）
   - `retry_count`: 重试次数（可选）

2. **响应格式**: 标准化响应格式，包含：
   - `success`: 操作是否成功
   - `message`: 操作结果消息
   - `data`: 详细的同步结果数据

### 远程服务要求
1. **API端点**: `/api/data/stock/{stock_code}/daily`
2. **查询参数**: `start_date`, `end_date`（YYYY-MM-DD格式）
3. **响应格式**: JSON格式，包含股票数据数组

### 错误处理要求
1. **重试机制**: 支持指数退避重试策略
2. **熔断器**: 防止级联故障
3. **降级策略**: 多级降级（远程->本地->缓存->模拟）
4. **错误日志**: 详细的错误信息和调试日志

## 实现计划

### 阶段1: 远程服务重启（立即）
- [ ] 安全重启远程数据服务
- [ ] 验证新API端点可用性
- [ ] 测试端到端数据同步流程

### 阶段2: 监控和优化（后续）
- [ ] 添加服务健康监控
- [ ] 优化重试和超时配置
- [ ] 完善错误处理和日志记录

## 测试计划

### 单元测试
- [x] API请求格式验证
- [x] 数据模型序列化/反序列化
- [x] 降级策略逻辑

### 集成测试
- [ ] 端到端数据同步流程
- [ ] 远程服务API调用
- [ ] 错误场景处理

### 性能测试
- [ ] 并发同步性能
- [ ] 大量数据同步稳定性
- [ ] 内存和CPU使用情况

## 风险评估

### 高风险
- **服务重启影响**: 重启远程服务可能影响其他依赖的功能

### 中风险
- **数据一致性**: 同步过程中的数据一致性问题
- **网络超时**: 网络不稳定导致的同步失败

### 低风险
- **配置错误**: 错误的配置参数导致功能异常

## 成功标准
1. 数据同步API返回200状态码，不再出现422错误
2. 远程数据服务API端点正常响应
3. 端到端数据同步流程完整工作
4. 降级策略在各种故障场景下正常工作
5. 系统性能和稳定性满足要求

## 相关文件
- `backend/app/api/routes.py` - API路由定义
- `backend/app/services/data_service.py` - 数据服务实现
- `backend/app/models/stock.py` - 数据模型定义
- `back_test_data_service/data_service/data_status_api.py` - 远程服务API
- `test_sync_fix.py` - 测试脚本