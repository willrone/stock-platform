# Willrone 回测系统性能优化方案

## 当前性能基线
- **任务ID**: 814287d1-202c-4109-a746-c932206bd840
- **总耗时**: 357.59秒 (5分58秒)
- **目标耗时**: < 180秒 (3分钟)
- **需要提升**: 2倍

## 性能瓶颈分析

### 1. 主要瓶颈：回测执行阶段 (71.1%)
- **耗时**: 254.30秒 (占总时间71.1%)
- **细分**:
  - `execute_trades_batch`: 72.14秒 (716次调用，平均0.101秒/次)
  - `generate_signals`: 13.92秒 (716次调用，平均0.019秒/次)
  - `slice_historical_data_work`: 6.09秒 (716次调用，平均0.0085秒/次)
  - `generate_signals_core_work`: 3.58秒 (710次调用，平均0.005秒/次)

### 2. 次要瓶颈：数据加载 (1.5%)
- **耗时**: 5.36秒
- **加载数据**: 500只股票，364,485条记录

### 3. 其他阶段
- 报告生成: 1.28秒 (0.36%)
- 指标计算: 0.015秒 (0.004%)

## 优化策略（按优先级排序）

### 优化1: 批量交易执行优化 ⭐⭐⭐⭐⭐
**目标**: 将 `execute_trades_batch` 从72秒降至 < 20秒
**预期提升**: 52秒 (14.5%)

**问题**:
- 716次批量调用，每次平均0.101秒
- 单次信号执行仅需0.000012秒，但批量处理效率低

**方案**:
1. 减少批量调用次数（合并多日信号）
2. 优化交易执行逻辑（避免重复计算）
3. 使用向量化操作替代循环

**实施步骤**:
- [ ] 分析 `execute_trades_batch` 代码
- [ ] 实现信号合并逻辑
- [ ] 向量化交易执行
- [ ] 测试验证

### 优化2: 信号生成优化 ⭐⭐⭐⭐
**目标**: 将 `generate_signals` 从13.92秒降至 < 5秒
**预期提升**: 8.92秒 (2.5%)

**问题**:
- 716次调用，每次0.019秒
- `slice_historical_data_work` 占用6.09秒（43.7%）

**方案**:
1. 缓存历史数据切片（避免重复切片）
2. 预计算技术指标（RSI等）
3. 使用滚动窗口而非每次切片

**实施步骤**:
- [ ] 实现数据切片缓存
- [ ] 预计算所有技术指标
- [ ] 使用滚动窗口优化
- [ ] 测试验证

### 优化3: 并行化处理 ⭐⭐⭐⭐⭐
**目标**: 利用多核CPU并行处理股票
**预期提升**: 100-150秒 (28-42%)

**问题**:
- CPU平均使用率仅0.1%（单核处理）
- 500只股票可以并行处理

**��案**:
1. 使用 `multiprocessing` 并行处理股票组
2. 每个进程处理50-100只股票
3. 合并结果

**实施步骤**:
- [ ] 设计并行架构
- [ ] 实现进程池处理
- [ ] 处理数据共享和结果合并
- [ ] 测试验证

### 优化4: 数据加载优化 ⭐⭐⭐
**目标**: 将数据加载从5.36秒降至 < 2秒
**预期提升**: 3.36秒 (0.9%)

**方案**:
1. 使用 `pyarrow` 引擎加速parquet读取
2. 只加载必要的列
3. 预过滤日期范围

**实施步骤**:
- [ ] 优化parquet读取参数
- [ ] 实现列选择和日期过滤
- [ ] 测试验证

### 优化5: 内存优化 ⭐⭐
**目标**: 降低内存峰值，提升缓存效率

**观察**:
- 内存峰值: 211.93 MB
- RSS增长: 418 MB → 749 MB

**方案**:
1. 使用 `category` 类型存储股票代码
2. 降低数据精度（float64 → float32）
3. 及时释放中间结果

## 优化顺序

**Phase 1: 快速优化（预计提升30-40秒）**
1. 优化4: 数据加载优化
2. 优化1: 批量交易执行优化（部分）

**Phase 2: 核心优化（预计提升100-150秒）**
3. 优化3: 并行化处理

**Phase 3: 精细优化（预计提升10-20秒）**
4. 优化2: 信号生成优化
5. 优化5: 内存优化

## 验收标准
- ✅ 500只股票×3年回测 < 180秒
- ✅ 回测结果正确（交易记录、指标合理）
- ✅ 代码提交到git
- ✅ 生成完整优化报告

## 风险评估
- **低风险**: 优化4（数据加载）
- **中风险**: 优化1、2（逻辑优化）
- **高风险**: 优化3（并行化，需要仔细处理数据共享）

## 时间估算
- Phase 1: 30分钟
- Phase 2: 45分钟
- Phase 3: 30分钟
- 测试验证: 30分钟
- **总计**: 约2小时
