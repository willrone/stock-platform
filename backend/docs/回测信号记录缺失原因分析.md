# 回测信号记录缺失原因分析（任务 13cab251）

## 1. 现象

- 任务 `13cab251-228e-4c80-b462-7764cccbe7ee` 有 283 笔交易记录（`trade_history`），但 `signal_records` 表中该任务记录数为 0。
- 前端“信号记录”无数据，“交易记录”正常。

## 2. 后端日志结论

在 `backend/data/logs/error.log` 中可查到该任务执行时的报错（2026-01-31 12:51:13）：

```
批量保存信号记录失败: (sqlite3.OperationalError) table signal_records has no column named execution_reason
[SQL: INSERT INTO signal_records (..., execution_reason, ...) VALUES (?, ..., ?, ...)]
```

同时出现：

- `batch_save_signal_records`：批量写入信号失败（每次有信号都会报一次）。
- `mark_signal_as_executed`：标记信号已执行失败（SELECT 含 `execution_reason`）。
- `update_signal_execution_reason`：更新未执行原因失败。

**根因**：代码和 ORM 模型里使用了 `execution_reason` 字段，但当前数据库里的 `signal_records` 表在创建时没有该列（对应迁移未执行或表是旧版本建表脚本建的），导致所有涉及该表的 INSERT/SELECT/UPDATE 都报错，信号一条都没写入。

## 3. 时间线（从日志）

| 时间       | 事件 |
|------------|------|
| 12:51:08   | 任务创建并提交进程池 |
| 12:51:12   | 子进程开始回测，task_id 正确传入 |
| 12:51:13   | 回测循环内多次“批量保存信号记录失败”（execution_reason 列不存在） |
| 12:51:23   | 回测完成，总收益 54.74% |
| 12:51:23   | 开始保存回测详细数据（组合快照、交易记录等） |
| 12:51:54   | 成功保存 490 个组合快照、283 条交易记录，统计信息保存成功 |

说明：交易记录是任务完成后由另一段逻辑从 `trade_history` 写入其他表，不依赖 `signal_records`，因此不受该列缺失影响。

## 4. 已做修复

1. **数据库**：在 `signal_records` 表上执行  
   `ALTER TABLE signal_records ADD COLUMN execution_reason TEXT;`  
   已执行完成，后续新任务的信号保存与“标记已执行/未执行原因”会正常。

2. **历史数据**：任务 13cab251 的 283 条信号已通过脚本  
   `scripts/backfill_signal_records_from_trades.py`  
   从 `trade_history` 回填到 `signal_records`，前端可正常查看。

3. **迁移脚本**：若在其他环境部署，可执行  
   `backend/migrations/add_execution_reason_to_signal_records.py`  
   确保表结构一致。

## 5. 建议

- 新环境或新库部署后，先跑一遍与 `signal_records` 相关的迁移（含 `add_execution_reason_to_signal_records`），再跑回测。
- 若再次出现“有交易无信号”，可先查 `error.log` 中是否仍有 `no column named execution_reason` 或 `batch_save_signal_records` 失败，并核对表结构。
