# 回测任务无交易信号问题分析报告

## 问题描述

老大创建了一个1000只股票的回测任务（task_id: `e4f9608f-89d2-495b-b1a0-af9a1e5142ab`），任务很快就显示完成但没有产生任何交易信号。

## 问题分析

### 1. 任务执行情况

通过日志分析发现：

- **任务开始时间**: 2026-02-05 21:08:23
- **任务取消时间**: 2026-02-05 21:18:40 (约10分钟后被取消)
- **任务状态**: `cancelled` (非正常完成)
- **交易记录数**: 0
- **信号记录数**: 0

**关键发现**: 任务并非"很快完成"，而是**执行超时后被取消**。日志中没有看到"回测任务完成"的记录，说明任务从未正常结束。

### 2. 任务配置对比

| 项目 | 失败任务 | 成功任务 |
|------|----------|----------|
| task_id | e4f9608f... | 7dbed878... |
| 策略 | portfolio (组合策略) | ml_ensemble_lgb_xgb_riskctl |
| 股票数量 | 1000 | 5 |
| 回测期间 | 2022-01-01 ~ 2026-02-05 (约1000天) | 2024-01-01 ~ 2025-01-01 (约232天) |
| 子策略 | bollinger + rsi + cointegration | 单一ML策略 |
| 执行时间 | >10分钟(超时) | ~2.5秒 |
| 交易记录 | 0 | 346 |

### 3. 根本原因

**组合策略 + 大规模股票池 = 计算量爆炸**

计算复杂度分析：
- 股票数量: 1000
- 交易日数: ~1000天
- 子策略数: 3 (bollinger, rsi, cointegration)
- 每日每股票需要:
  - 计算3个策略的技术指标
  - 生成3个策略的信号
  - 信号整合(加权投票)

**总计算量**: 1000 × 1000 × 3 = **30亿次**基础操作

特别是 `CointegrationStrategy` 策略需要计算半衰期（涉及线性回归），计算开销很大。

### 4. 代码层面的问题

虽然代码中有向量化预计算优化，但存在以下问题：

1. **组合策略的信号整合未向量化**: `StrategyPortfolio.generate_signals()` 在每个交易日都需要：
   - 收集所有子策略的信号
   - 调用 `SignalIntegrator.integrate()` 进行加权投票
   - 这个过程是逐日执行的，无法向量化

2. **预计算信号的key不一致**: 
   - 预计算时使用 `strategy.name` 作为key
   - 但 `_build_aligned_arrays` 中对组合策略的处理不完整
   - 组合策略的子策略信号没有被正确整合到 aligned_arrays 中

3. **缺少进度反馈**: 任务执行过程中没有及时更新进度，用户无法知道任务实际执行状态

## 解决方案

### 方案1: 限制股票数量（临时方案）

在前端或后端添加股票数量限制，建议组合策略最多支持100只股票。

### 方案2: 优化组合策略的信号整合（推荐）

修改 `StrategyPortfolio` 类，实现向量化的信号整合：

```python
def precompute_all_signals(self, data: pd.DataFrame) -> Optional[pd.Series]:
    """向量化预计算组合策略信号"""
    # 1. 收集所有子策略的预计算信号
    sub_signals = []
    for strategy in self.strategies:
        sig = strategy.precompute_all_signals(data)
        if sig is not None:
            sub_signals.append((strategy.name, sig))
    
    if not sub_signals:
        return None
    
    # 2. 向量化整合信号（按日期对齐后加权投票）
    # ... 实现向量化的加权投票逻辑
```

### 方案3: 添加任务超时和进度监控

1. 设置合理的任务超时时间
2. 在预计算阶段就估算任务复杂度
3. 对于超大规模任务，提前警告用户

## 立即可行的修复

修改 `_build_aligned_arrays` 方法，正确处理组合策略：

```python
# 在 _build_aligned_arrays 中添加对组合策略的处理
if isinstance(strategy, StrategyPortfolio):
    # 对于组合策略，需要整合所有子策略的信号
    for sub_strategy in strategy.strategies:
        sub_key = sub_strategy.name
        # ... 整合子策略信号
```

## 已完成的修复

### 修复内容

在 `backend/app/services/backtest/core/strategy_portfolio.py` 中为 `StrategyPortfolio` 类添加了 `precompute_all_signals` 方法：

1. **向量化预计算**: 一次性计算所有子策略的信号，避免在回测循环中逐日计算
2. **向量化信号整合**: 使用加权投票算法整合多个子策略的信号
3. **优先使用预计算**: 修改 `generate_signals` 方法，优先使用预计算的信号

### 性能提升预期

- **原来**: 1000股票 × 1000天 × 3策略 = 30亿次逐日计算
- **现在**: 1000股票 × 3策略 = 3000次向量化计算（每次处理1000天）

预计性能提升 **100-1000倍**。

### 验证方法

重新运行1000只股票的回测任务，观察：
1. 任务是否能正常完成
2. 是否产生交易信号
3. 执行时间是否显著缩短

## 建议的下一步行动

1. **立即**: 重新测试1000只股票的回测任务，验证修复效果
2. **短期**: 在前端添加股票数量警告，超过100只时提示用户任务可能耗时较长
3. **中期**: 添加任务进度实时反馈，让用户了解大规模任务的执行状态
4. **长期**: 考虑使用分布式计算框架处理超大规模回测任务

---

**分析时间**: 2026-02-05 21:21
**修复完成时间**: 2026-02-05 21:27
**分析人**: AI Assistant (backtest-debug-2)
