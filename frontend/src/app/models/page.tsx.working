/**
 * æ¨¡å‹ç®¡ç†é¡µé¢
 * 
 * æä¾›æ¨¡å‹åˆ›å»ºã€æŸ¥çœ‹å’Œç®¡ç†åŠŸèƒ½
 */

'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
  Card,
  CardHeader,
  CardBody,
  Button,
  Input,
  Select,
  SelectItem,
  Table,
  TableHeader,
  TableColumn,
  TableBody,
  TableRow,
  TableCell,
  Chip,
  Modal,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  useDisclosure,
  Progress,
  Tooltip,
} from '@heroui/react';
import {
  Plus,
  Brain,
  TrendingUp,
  Calendar,
  Settings,
  RefreshCw,
  Trash2,
} from 'lucide-react';
import {
  Accordion,
  AccordionItem,
  Checkbox,
} from '@heroui/react';
import { DataService } from '../../services/dataService';
import { useDataStore, Model } from '../../stores/useDataStore';
import { LoadingSpinner } from '../../components/common/LoadingSpinner';
import { StockSelector } from '../../components/tasks/StockSelector';
import { TrainingReportModal } from '../../components/models/TrainingReportModal';
import { getTrainingProgressWebSocket, cleanupTrainingProgressWebSocket } from '../../services/TrainingProgressWebSocket';

export default function ModelsPage() {
  const router = useRouter();
  const { models, setModels } = useDataStore();
  const [loading, setLoading] = useState(false);
  const [creating, setCreating] = useState(false);
  const { isOpen, onOpen, onClose } = useDisclosure();
  const { isOpen: isDetailOpen, onOpen: onDetailOpen, onClose: onDetailClose } = useDisclosure();
  const { isOpen: isLiveTrainingOpen, onOpen: onLiveTrainingOpen, onClose: onLiveTrainingClose } = useDisclosure();
  const { isOpen: isTrainingReportOpen, onOpen: onTrainingReportOpen, onClose: onTrainingReportClose } = useDisclosure();
  const [selectedModel, setSelectedModel] = useState<Model | null>(null);
  const [liveTrainingModelId, setLiveTrainingModelId] = useState<string | null>(null);
  const [trainingReportModelId, setTrainingReportModelId] = useState<string | null>(null);
  const [detailLoading, setDetailLoading] = useState(false);
  const [loadingModelId, setLoadingModelId] = useState<string | null>(null);
  const [retrainingModelId, setRetrainingModelId] = useState<string | null>(null);
  const [deletingModelId, setDeletingModelId] = useState<string | null>(null);
  
  // WebSocketè¿æ¥çŠ¶æ€
  const [wsConnected, setWsConnected] = useState(false);
  const [trainingProgress, setTrainingProgress] = useState<Record<string, any>>({});
  
  const [formData, setFormData] = useState({
    model_name: '',
    model_type: 'lightgbm',
    stock_codes: [] as string[],
    start_date: '',
    end_date: '',
    description: '',
    hyperparameters: {} as Record<string, any>,
    enable_hyperparameter_tuning: false,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  // åŠ è½½æ¨¡å‹åˆ—è¡¨
  const loadModels = async () => {
    try {
      setLoading(true);
      const data = await DataService.getModels();
      setModels(data.models || data);
    } catch (error) {
      console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  // è®¾ç½®WebSocketè¿æ¥
  const setupWebSocketConnection = async () => {
    try {
      const wsClient = getTrainingProgressWebSocket();
      
      // è¿æ¥WebSocket
      await wsClient.connect();
      setWsConnected(true);
      
      // è®¢é˜…æ‰€æœ‰è®­ç»ƒè¿›åº¦æ›´æ–°
      const unsubscribe = wsClient.subscribeToAll((data) => {
        handleWebSocketMessage(data);
      });
      
      // ä¿å­˜å–æ¶ˆè®¢é˜…å‡½æ•°ä»¥ä¾¿æ¸…ç†
      (window as any).unsubscribeTrainingProgress = unsubscribe;
      
    } catch (error) {
      console.error('è®¾ç½®WebSocketè¿æ¥å¤±è´¥:', error);
      setWsConnected(false);
    }
  };

  // å¤„ç†WebSocketæ¶ˆæ¯
  const handleWebSocketMessage = (data: any) => {
    if (data.type === 'model:training:progress') {
      setTrainingProgress(prev => ({
        ...prev,
        [data.model_id]: {
          progress: data.progress,
          stage: data.stage,
          message: data.message,
          metrics: data.metrics || {},
          timestamp: data.timestamp
        }
      }));
      
      // æ›´æ–°æ¨¡å‹åˆ—è¡¨ä¸­çš„è¿›åº¦
      const updatedModels = models.map((model: Model): Model => 
        model.model_id === data.model_id 
          ? { 
              ...model, 
              training_progress: data.progress,
              training_stage: data.stage,
              status: (data.progress >= 100 ? 'ready' : 'training') as Model['status']
            }
          : model
      );
      setModels(updatedModels);
    } else if (data.type === 'model:training:completed') {
      // è®­ç»ƒå®Œæˆï¼Œåˆ·æ–°æ¨¡å‹åˆ—è¡¨
      loadModels();
      setTrainingProgress(prev => {
        const updated = { ...prev };
        delete updated[data.model_id];
        return updated;
      });
    } else if (data.type === 'model:training:failed') {
      // è®­ç»ƒå¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
      const updatedModels = models.map((model: Model): Model => 
        model.model_id === data.model_id 
          ? { ...model, status: 'failed', training_stage: 'failed' }
          : model
      );
      setModels(updatedModels);
      setTrainingProgress(prev => {
        const updated = { ...prev };
        delete updated[data.model_id];
        return updated;
      });
    }
  };

  // è·å–çŠ¶æ€é¢œè‰²
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'ready':
        return 'success';
      case 'active':
        return 'primary';
      case 'deployed':
        return 'secondary';
      case 'training':
        return 'warning';
      case 'failed':
        return 'danger';
      default:
        return 'default';
    }
  };

  // è·å–çŠ¶æ€æ–‡æœ¬
  const getStatusText = (status: string) => {
    const statusMap: Record<string, string> = {
      'ready': 'å°±ç»ª',
      'active': 'æ´»è·ƒ',
      'deployed': 'å·²éƒ¨ç½²',
      'training': 'è®­ç»ƒä¸­',
      'failed': 'å¤±è´¥',
    };
    return statusMap[status] || status;
  };

  // è·å–è®­ç»ƒé˜¶æ®µæ–‡æœ¬
  const getStageText = (stage: string) => {
    const stageMap: Record<string, string> = {
      'initializing': 'åˆå§‹åŒ–ä¸­',
      'preparing': 'å‡†å¤‡æ•°æ®',
      'configuring': 'é…ç½®æ¨¡å‹',
      'preprocessing': 'æ•°æ®é¢„å¤„ç†',
      'training': 'æ¨¡å‹è®­ç»ƒ',
      'evaluating': 'æ¨¡å‹è¯„ä¼°',
      'saving': 'ä¿å­˜æ¨¡å‹',
      'completed': 'è®­ç»ƒå®Œæˆ',
      'failed': 'è®­ç»ƒå¤±è´¥',
      'hyperparameter_tuning': 'è¶…å‚æ•°è°ƒä¼˜'
    };
    return stageMap[stage] || stage;
  };

  // æ˜¾ç¤ºå®æ—¶è®­ç»ƒè¯¦æƒ…
  const showLiveTrainingDetails = (modelId: string) => {
    setLiveTrainingModelId(modelId);
    onLiveTrainingOpen();
  };

  // æ˜¾ç¤ºè®­ç»ƒæŠ¥å‘Š
  const showTrainingReport = (modelId: string) => {
    setTrainingReportModelId(modelId);
    onTrainingReportOpen();
  };

  // éªŒè¯è¡¨å•
  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    
    if (!formData.model_name.trim()) {
      newErrors.model_name = 'è¯·è¾“å…¥æ¨¡å‹åç§°';
    }
    
    if (formData.stock_codes.length === 0) {
      newErrors.stock_codes = 'è¯·è‡³å°‘é€‰æ‹©ä¸€åªè‚¡ç¥¨ç”¨äºè®­ç»ƒ';
    }
    
    if (!formData.start_date) {
      newErrors.start_date = 'è¯·é€‰æ‹©è®­ç»ƒæ•°æ®å¼€å§‹æ—¥æœŸ';
    }
    
    if (!formData.end_date) {
      newErrors.end_date = 'è¯·é€‰æ‹©è®­ç»ƒæ•°æ®ç»“æŸæ—¥æœŸ';
    }
    
    if (formData.start_date && formData.end_date && formData.start_date >= formData.end_date) {
      newErrors.end_date = 'ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // æäº¤åˆ›å»ºæ¨¡å‹è¡¨å•
  const handleSubmit = async () => {
    if (!validateForm()) {
      return;
    }

    setCreating(true);
    try {
      const result = await DataService.createModel(formData);
      console.log('æ¨¡å‹åˆ›å»ºæˆåŠŸ:', result);
      
      // é‡ç½®è¡¨å•
      setFormData({
        model_name: '',
        model_type: 'lightgbm',
        stock_codes: [],
        start_date: '',
        end_date: '',
        description: '',
        hyperparameters: {},
        enable_hyperparameter_tuning: false,
      });
      setErrors({});
      
      // å…³é—­å¯¹è¯æ¡†å¹¶åˆ·æ–°åˆ—è¡¨
      onClose();
      await loadModels();
      
      alert('æ¨¡å‹åˆ›å»ºæˆåŠŸï¼è®­ç»ƒä»»åŠ¡å·²å¼€å§‹ï¼Œæ‚¨å¯ä»¥åœ¨æ¨¡å‹åˆ—è¡¨ä¸­æŸ¥çœ‹è¿›åº¦ã€‚');
    } catch (error: any) {
      console.error('åˆ›å»ºæ¨¡å‹å¤±è´¥:', error);
      alert(error?.message || 'åˆ›å»ºæ¨¡å‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      setCreating(false);
    }
  };

  useEffect(() => {
    loadModels();
    setupWebSocketConnection();
    
    return () => {
      // æ¸…ç†WebSocketè¿æ¥
      cleanupTrainingProgressWebSocket();
    };
  }, []);

  if (loading && models.length === 0) {
    return <LoadingSpinner text="åŠ è½½æ¨¡å‹åˆ—è¡¨..." />;
  }

  return (
    <div className="container mx-auto px-4 py-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Brain className="w-8 h-8" />
            æ¨¡å‹ç®¡ç†
          </h1>
          <p className="text-default-500 mt-2">åˆ›å»ºå’Œç®¡ç†é¢„æµ‹æ¨¡å‹</p>
        </div>
        <Button
          color="primary"
          startContent={<Plus className="w-4 h-4" />}
          onPress={onOpen}
        >
          åˆ›å»ºæ¨¡å‹
        </Button>
      </div>

      <Card>
        <CardHeader>
          <div className="flex items-center space-x-2">
            <TrendingUp className="w-5 h-5" />
            <h2 className="text-lg font-semibold">æ¨¡å‹åˆ—è¡¨</h2>
            <span className="text-default-500">({models.length} ä¸ª)</span>
          </div>
        </CardHeader>
        <CardBody>
          {models.length === 0 ? (
            <div className="text-center py-12">
              <Brain className="w-16 h-16 mx-auto text-default-300 mb-4" />
              <p className="text-default-500 text-lg mb-2">æš‚æ— æ¨¡å‹</p>
              <p className="text-default-400 text-sm mb-4">
                åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªé¢„æµ‹æ¨¡å‹å¼€å§‹ä½¿ç”¨
              </p>
              <Button
                color="primary"
                startContent={<Plus className="w-4 h-4" />}
                onPress={onOpen}
              >
                åˆ›å»ºæ¨¡å‹
              </Button>
            </div>
          ) : (
            <Table aria-label="æ¨¡å‹åˆ—è¡¨">
              <TableHeader>
                <TableColumn>æ¨¡å‹åç§°</TableColumn>
                <TableColumn>ç±»å‹</TableColumn>
                <TableColumn>å‡†ç¡®ç‡</TableColumn>
                <TableColumn>ç‰ˆæœ¬</TableColumn>
                <TableColumn>çŠ¶æ€</TableColumn>
                <TableColumn>åˆ›å»ºæ—¶é—´</TableColumn>
                <TableColumn>æ“ä½œ</TableColumn>
              </TableHeader>
              <TableBody>
                {models.map((model) => (
                  <TableRow key={model.model_id}>
                    <TableCell>
                      <div className="flex flex-col">
                        <span className="font-medium">{model.model_name}</span>
                        {model.description && (
                          <span className="text-xs text-default-500">
                            {model.description}
                          </span>
                        )}
                      </div>
                    </TableCell>
                    <TableCell>{model.model_type}</TableCell>
                    <TableCell>
                      <span className="font-medium">
                        {(model.accuracy * 100).toFixed(1)}%
                      </span>
                    </TableCell>
                    <TableCell>{model.version}</TableCell>
                    <TableCell>
                      <div className="flex flex-col gap-1">
                        <Chip
                          size="sm"
                          color={getStatusColor(model.status)}
                          variant="flat"
                        >
                          {getStatusText(model.status)}
                        </Chip>
                        
                        {/* è®­ç»ƒè¿›åº¦æ˜¾ç¤º */}
                        {model.status === 'training' && (
                          <div className="space-y-1">
                            <div className="flex items-center gap-2">
                              <Progress 
                                value={trainingProgress[model.model_id]?.progress || model.training_progress || 0}
                                size="sm"
                                className="flex-1"
                                color="primary"
                              />
                              <span className="text-xs text-default-500 min-w-[40px]">
                                {(trainingProgress[model.model_id]?.progress || model.training_progress || 0).toFixed(0)}%
                              </span>
                            </div>
                            
                            {/* è®­ç»ƒé˜¶æ®µå’Œæ¶ˆæ¯ */}
                            <div className="text-xs text-default-400">
                              {trainingProgress[model.model_id]?.message || 
                               getStageText(trainingProgress[model.model_id]?.stage || model.training_stage)}
                            </div>
                            
                            {/* å®æ—¶æŒ‡æ ‡ */}
                            {trainingProgress[model.model_id]?.metrics && Object.keys(trainingProgress[model.model_id].metrics).length > 0 && (
                              <div className="flex gap-2 text-xs">
                                {Object.entries(trainingProgress[model.model_id].metrics).slice(0, 2).map(([key, value]) => (
                                  <Tooltip key={key} content={key}>
                                    <span className="text-default-500">
                                      {key}: {typeof value === 'number' ? value.toFixed(3) : String(value)}
                                    </span>
                                  </Tooltip>
                                ))}
                              </div>
                            )}
                            
                            {/* æŸ¥çœ‹å®æ—¶è¯¦æƒ…æŒ‰é’® */}
                            <Button
                              size="sm"
                              variant="light"
                              color="primary"
                              className="text-xs h-6"
                              onPress={() => showLiveTrainingDetails(model.model_id)}
                            >
                              æŸ¥çœ‹å®æ—¶è¯¦æƒ…
                            </Button>
                          </div>
                        )}
                        
                        {/* éè®­ç»ƒçŠ¶æ€çš„ç®€å•æ˜¾ç¤º */}
                        {model.status !== 'training' && model.training_stage && (
                          <span className="text-xs text-default-400">
                            {getStageText(model.training_stage)}
                          </span>
                        )}
                      </div>
                    </TableCell>
                    <TableCell>
                      {new Date(model.created_at).toLocaleDateString('zh-CN')}
                    </TableCell>
                    <TableCell>
                      <div className="flex gap-2">
                        <Button
                          size="sm"
                          variant="light"
                          onPress={async () => {
                            setLoadingModelId(model.model_id);
                            setDetailLoading(true);
                            try {
                              const detail = await DataService.getModelDetail(model.model_id);
                              setSelectedModel(detail);
                              onDetailOpen();
                            } catch (error) {
                              console.error('åŠ è½½æ¨¡å‹è¯¦æƒ…å¤±è´¥:', error);
                              alert('åŠ è½½æ¨¡å‹è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                            } finally {
                              setDetailLoading(false);
                              setLoadingModelId(null);
                            }
                          }}
                          isLoading={detailLoading && loadingModelId === model.model_id}
                        >
                          æŸ¥çœ‹
                        </Button>
                        {model.status === 'ready' && (
                          <Button
                            size="sm"
                            variant="light"
                            color="primary"
                            onPress={() => showTrainingReport(model.model_id)}
                          >
                            æŠ¥å‘Š
                          </Button>
                        )}
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardBody>
      </Card>

      {/* åˆ›å»ºæ¨¡å‹å¯¹è¯æ¡† */}
      <Modal isOpen={isOpen} onClose={onClose} size="4xl" scrollBehavior="inside">
        <ModalContent>
          <ModalHeader>
            <div className="flex items-center space-x-2">
              <Plus className="w-5 h-5" />
              <span>åˆ›å»ºæ–°æ¨¡å‹</span>
            </div>
          </ModalHeader>
          <ModalBody>
            <div className="space-y-4">
              <Input
                label="æ¨¡å‹åç§°"
                placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°"
                value={formData.model_name}
                onValueChange={(value) =>
                  setFormData((prev) => ({ ...prev, model_name: value }))
                }
                isInvalid={!!errors.model_name}
                errorMessage={errors.model_name}
                isRequired
              />

              {/* æ¨¡å‹æ¨èåŠ©æ‰‹ */}
              <Card className="bg-blue-50 border-blue-200">
                <CardBody className="py-3">
                  <div className="flex items-start gap-3">
                    <div className="text-blue-600 mt-1">
                      <Brain className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <h4 className="text-sm font-medium text-blue-900 mb-1">æ¨¡å‹é€‰æ‹©å»ºè®®</h4>
                      <div className="text-xs text-blue-700 space-y-1">
                        <p><strong>æ–°æ‰‹æ¨èï¼š</strong> LightGBM - æ•ˆæœå¥½ï¼Œè®­ç»ƒå¿«ï¼Œæ˜“è°ƒå‚</p>
                        <p><strong>æ•°æ®é‡å¤§ï¼ˆ>10ä¸‡æ¡ï¼‰ï¼š</strong> Transformerã€Informer - æ·±åº¦å­¦ä¹ ä¼˜åŠ¿æ˜æ˜¾</p>
                        <p><strong>æ•°æ®é‡å°ï¼ˆ<5ä¸‡æ¡ï¼‰ï¼š</strong> LightGBMã€XGBoost - ä¼ ç»ŸMLæ›´ç¨³å®š</p>
                        <p><strong>é•¿æœŸé¢„æµ‹ï¼š</strong> Informerã€TimesNet - ä¸“ä¸ºé•¿åºåˆ—è®¾è®¡</p>
                        <p><strong>å¿«é€ŸéªŒè¯ï¼š</strong> çº¿æ€§å›å½’ - å‡ åˆ†é’Ÿå®Œæˆè®­ç»ƒ</p>
                      </div>
                    </div>
                  </div>
                </CardBody>
              </Card>

              <Select
                label="æ¨¡å‹ç±»å‹"
                selectedKeys={[formData.model_type]}
                onSelectionChange={(keys) => {
                  const type = Array.from(keys)[0] as string;
                  setFormData((prev) => ({ ...prev, model_type: type }));
                }}
                description="é€‰æ‹©è¦è®­ç»ƒçš„æ¨¡å‹ç±»å‹ï¼ˆåŸºäºQlibæ¡†æ¶ç»Ÿä¸€è®­ç»ƒï¼‰"
              >
                {/* ä¼ ç»Ÿæœºå™¨å­¦ä¹ æ¨¡å‹ - æ¨èæ–°æ‰‹ä½¿ç”¨ */}
                <SelectItem key="lightgbm" description="ğŸŒŸ æ¨èï¼šé«˜æ•ˆçš„æ¢¯åº¦æå‡æ¨¡å‹ï¼Œé€‚åˆè¡¨æ ¼æ•°æ®ï¼Œè®­ç»ƒé€Ÿåº¦å¿«ï¼Œæ•ˆæœç¨³å®š">
                  LightGBM (æ¨èæ–°æ‰‹)
                </SelectItem>
                <SelectItem key="xgboost" description="ç»å…¸çš„æ¢¯åº¦æå‡æ¨¡å‹ï¼Œæ€§èƒ½ç¨³å®šï¼Œå¯è§£é‡Šæ€§å¼ºï¼Œé€‚åˆç»“æ„åŒ–æ•°æ®">
                  XGBoost
                </SelectItem>
                <SelectItem key="linear_regression" description="ç®€å•çš„çº¿æ€§å›å½’æ¨¡å‹ï¼Œè®­ç»ƒå¿«é€Ÿï¼Œé«˜å¯è§£é‡Šæ€§ï¼Œé€‚åˆåŸºçº¿æ¨¡å‹">
                  çº¿æ€§å›å½’
                </SelectItem>
                <SelectItem key="random_forest" description="ä¼ ç»Ÿéšæœºæ£®æ—æ¨¡å‹ï¼ˆå·²ä¼˜åŒ–ä¸ºLightGBMå®ç°ï¼‰">
                  éšæœºæ£®æ—
                </SelectItem>

                {/* æ·±åº¦å­¦ä¹ æ¨¡å‹ - é€‚åˆå¤§æ•°æ®é‡ */}
                <SelectItem key="transformer" description="ğŸš€ Transformeræ¨¡å‹ï¼Œé€‚åˆå¤æ‚æ—¶åºæ¨¡å¼ï¼Œéœ€è¦å¤§é‡æ•°æ®">
                  Transformer (æ·±åº¦å­¦ä¹ )
                </SelectItem>
                <SelectItem key="informer" description="ä¸“ä¸ºé•¿åºåˆ—é¢„æµ‹è®¾è®¡çš„Transformerå˜ä½“ï¼Œå†…å­˜æ•ˆç‡é«˜">
                  Informer (é•¿åºåˆ—ä¸“ç”¨)
                </SelectItem>
                <SelectItem key="timesnet" description="æœ€æ–°çš„æ—¶åºé¢„æµ‹æ¨¡å‹ï¼Œå¤šå‘¨æœŸå»ºæ¨¡èƒ½åŠ›å¼º">
                  TimesNet (æœ€æ–°)
                </SelectItem>
                <SelectItem key="patchtst" description="åŸºäºPatchçš„Transformerï¼Œåœ¨å¤šä¸ªæ—¶åºä»»åŠ¡ä¸Šè¡¨ç°ä¼˜å¼‚">
                  PatchTST (é«˜æ€§èƒ½)
                </SelectItem>
              </Select>

              <StockSelector
                selectedStocks={formData.stock_codes}
                onSelectionChange={(codes) =>
                  setFormData((prev) => ({ ...prev, stock_codes: codes }))
                }
                error={errors.stock_codes}
              />

              <div className="grid grid-cols-2 gap-4">
                <Input
                  type="date"
                  label="è®­ç»ƒæ•°æ®å¼€å§‹æ—¥æœŸ"
                  value={formData.start_date}
                  onValueChange={(value) =>
                    setFormData((prev) => ({ ...prev, start_date: value }))
                  }
                  isInvalid={!!errors.start_date}
                  errorMessage={errors.start_date}
                  isRequired
                />
                <Input
                  type="date"
                  label="è®­ç»ƒæ•°æ®ç»“æŸæ—¥æœŸ"
                  value={formData.end_date}
                  onValueChange={(value) =>
                    setFormData((prev) => ({ ...prev, end_date: value }))
                  }
                  isInvalid={!!errors.end_date}
                  errorMessage={errors.end_date}
                  isRequired
                />
              </div>

              <Input
                label="æ¨¡å‹æè¿°ï¼ˆå¯é€‰ï¼‰"
                placeholder="è¯·è¾“å…¥æ¨¡å‹æè¿°"
                value={formData.description}
                onValueChange={(value) =>
                  setFormData((prev) => ({ ...prev, description: value }))
                }
              />

              <Checkbox
                isSelected={formData.enable_hyperparameter_tuning}
                onValueChange={(checked) =>
                  setFormData((prev) => ({ ...prev, enable_hyperparameter_tuning: checked }))
                }
              >
                å¯ç”¨è‡ªåŠ¨è¶…å‚æ•°è°ƒä¼˜ï¼ˆå¢åŠ è®­ç»ƒæ—¶é—´ä½†å¯èƒ½æå‡æ•ˆæœï¼‰
              </Checkbox>
            </div>
          </ModalBody>
          <ModalFooter>
            <Button variant="light" onPress={onClose}>
              å–æ¶ˆ
            </Button>
            <Button
              color="primary"
              onPress={handleSubmit}
              isLoading={creating}
              startContent={!creating ? <Plus className="w-4 h-4" /> : undefined}
            >
              {creating ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºæ¨¡å‹'}
            </Button>
          </ModalFooter>
        </ModalContent>
      </Modal>

      {/* è®­ç»ƒæŠ¥å‘Šè¯¦æƒ…å¼¹çª— */}
      <TrainingReportModal
        isOpen={isTrainingReportOpen}
        onClose={onTrainingReportClose}
        modelId={trainingReportModelId}
      />
    </div>
  );
}