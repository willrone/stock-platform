# 局域网访问配置说明

## 问题背景

当从局域网其他电脑访问前端时，如果前端代码中使用 `localhost:8000` 作为API地址，浏览器会尝试从客户端机器访问 `localhost:8000`，而不是从服务器访问，导致API请求失败。

## 解决方案

使用 **Next.js 代理方案**：
- 前端API请求使用相对路径 `/api/v1`
- Next.js服务器自动将 `/api/*` 请求代理到后端服务器
- WebSocket连接直接连接到后端服务器IP地址

## 配置步骤

### 1. 配置环境变量

编辑 `frontend/.env.local` 文件，添加以下配置：

```env
# 后端服务器地址（用于Next.js代理和WebSocket连接）
# 格式: hostname:port 或 ip:port
NEXT_PUBLIC_BACKEND_HOST=192.168.3.62:8000

# 可选：WebSocket服务地址（如果不设置将从BACKEND_HOST自动推断）
# NEXT_PUBLIC_WS_URL=ws://192.168.3.62:8000/ws

# 可选：后端服务器端口（默认8000）
# NEXT_PUBLIC_BACKEND_PORT=8000
```

### 2. 重启前端服务

修改环境变量后，需要重启Next.js开发服务器：

```bash
cd frontend
npm run dev
```

### 3. 验证配置

从另一台电脑访问 `http://192.168.3.62:3000`，打开浏览器开发者工具：
- 检查API请求的URL应该是 `/api/v1/...`（相对路径）
- 检查Network标签中的请求，应该能正常响应
- 检查WebSocket连接，应该连接到 `ws://192.168.3.62:8000/ws`

## 工作原理

### API请求流程

```
客户端浏览器 
  → 请求 /api/v1/tasks (相对路径)
  → Next.js服务器 (3000端口)
  → Next.js rewrites代理
  → 后端服务器 (192.168.3.62:8000)
  → 返回响应
  → Next.js服务器
  → 客户端浏览器
```

### WebSocket连接

WebSocket不能通过HTTP代理，因此：
- 从当前页面的 `hostname` 推断后端服务器地址
- 使用环境变量 `NEXT_PUBLIC_BACKEND_PORT` 或默认8000端口
- 直接连接到 `ws://{hostname}:8000/ws`

## 配置选项

### 方案1：使用环境变量（推荐）

在 `.env.local` 中设置：
```env
NEXT_PUBLIC_BACKEND_HOST=192.168.3.62:8000
```

**优点**：配置明确，易于管理  
**缺点**：需要手动设置IP地址

### 方案2：自动推断（备用）

不设置环境变量，系统会自动从当前访问地址推断后端地址。

**优点**：无需配置  
**缺点**：如果前端和后端不在同一台机器或端口不同，可能无法正确推断

## 注意事项

1. **后端CORS配置**：确保后端允许来自 `http://192.168.3.62:3000` 的请求
   - 配置文件：`backend/app/core/config.py`
   - 默认已包含：`http://192.168.3.62:3000`

2. **后端服务器地址**：确保后端监听 `0.0.0.0:8000` 而不是 `127.0.0.1:8000`
   - 配置文件：`backend/app/core/config.py`
   - 默认值：`HOST: "0.0.0.0"` ✓

3. **防火墙设置**：确保Mac防火墙允许8000端口的入站连接

4. **动态IP问题**：如果服务器IP会变化，考虑：
   - 使用固定IP地址
   - 配置DHCP保留IP
   - 使用域名（如果有DNS服务器）

## 故障排查

### API请求仍然失败

1. 检查 `.env.local` 配置是否正确
2. 确认已重启前端服务
3. 检查浏览器Network标签，查看实际请求URL
4. 检查Next.js服务器日志，查看代理是否工作

### WebSocket连接失败

1. 检查浏览器Console，查看WebSocket连接URL
2. 确认后端WebSocket服务已启动
3. 检查防火墙是否阻止8000端口
4. 尝试直接访问 `ws://192.168.3.62:8000/ws` 测试连接

### 从本地访问正常，局域网访问失败

1. 确认 `.env.local` 中配置的是局域网IP，不是localhost
2. 确认后端服务监听在 `0.0.0.0` 而不是 `127.0.0.1`
3. 检查Mac防火墙设置
