# 修复后端API阻塞问题（混合方案）

## 问题分析

**核心问题**：
1. FastAPI的`background_tasks`在同一个事件循环中执行，阻塞了整个服务
2. 回测任务是CPU密集型操作，受Python GIL限制，单进程无法充分利用多核CPU
3. 直接使用多进程会带来SQLite锁竞争、全局状态不一致等问题

## 修复方案（混合模式）

### 1. 异步任务队列 + 进程池执行器

**修改文件**：`backend/app/services/tasks/task_queue.py`
- 使用`concurrent.futures.ProcessPoolExecutor`执行CPU密集型任务
- 保持主进程的异步架构，避免API阻塞
- 限制进程池大小（默认3个）
- 实现任务优先级调度

### 2. 分离任务执行与API服务

**修改文件**：`backend/app/api/v1/tasks.py`
- API服务只负责接收请求和返回响应
- 耗时的任务执行通过进程池异步执行
- 减少主进程的CPU使用率

### 3. 优化数据库操作

**修改文件**：`backend/app/core/database.py`
- 实现连接池管理
- 限制最大连接数
- 添加超时机制
- 优化SQL查询

### 4. 实现任务状态同步机制

**修改文件**：`backend/app/services/tasks/task_monitor.py`
- 实现进程间的状态同步
- 使用文件锁或共享内存进行通信
- 避免直接访问共享资源

### 5. 配置调整

**修改文件**：`backend/app/core/config.py`
- 增加`PROCESS_POOL_SIZE`配置
- 添加`TASK_EXECUTION_TIMEOUT`配置
- 配置数据库连接池参数

## 技术优势

1. **解决API阻塞**：主进程保持异步，不会阻塞其他API请求
2. **充分利用CPU资源**：通过进程池执行CPU密集型任务，突破GIL限制
3. **避免SQLite锁竞争**：任务执行进程与API进程分离，减少数据库访问冲突
4. **易维护**：代码结构清晰，易于调试和维护
5. **兼容现有架构**：不需要大规模重构

## 预期效果

1. 修复后，创建任务不会阻塞其他API请求
2. 所有API请求都能正常响应
3. 充分利用多核CPU资源执行回测任务
4. 系统响应速度恢复正常
5. 避免了纯多进程带来的部分风险

## 验证方法

1. 创建一个回测任务
2. 同时发送其他API请求（获取任务列表、模型信息等）
3. 观察所有请求是否都能正常响应
4. 检查后端日志，确认没有阻塞现象
5. 监控系统资源使用情况，确认多核CPU被充分利用

## 安全考量

1. 分离API服务和任务执行，减少风险
2. 使用进程池管理，避免资源泄漏
3. 实现超时机制，防止任务无限执行
4. 优化数据库操作，减少锁竞争
5. 保持代码的可维护性和可调试性