# 回测信号执行率低问题分析与解决方案

## 一、问题现象

回测过程中**信号执行率很低**，大部分买入信号因**资金被用完无法买入**而未能执行。

---

## 二、根本原因分析

### 2.1 当前持仓管理逻辑概览

核心逻辑位于 `backend/app/services/backtest/core/portfolio_manager.py` 的 `_execute_buy` 方法：

```python
# 1. 计算该股可用资金额度
portfolio_value = get_portfolio_value(...)
max_position_value = portfolio_value * max_position_size  # 如 20%
available_cash_for_stock = max_position_value - current_position_value

# 2. 限制：最多用 95% 现金
available_cash_for_stock = min(available_cash_for_stock, self.cash * 0.95)

# 3. 100 股取整
quantity = int(available_cash_for_stock / price / 100) * 100

# 4. 最终检查：实际成本不能超过现金
if total_cost_with_commission > self.cash:
    return None, "资金不足"
```

### 2.2 导致执行率低的主要原因

| 原因 | 说明 | 影响 |
|-----|------|-----|
| **1. 顺序执行 + 先到先得** | 信号按策略返回顺序**串行**执行，先执行的把现金用掉，后面的就"资金不足" | 高 |
| **2. 保留 5% 现金刚性约束** | `available = min(..., cash*0.95)`，当 cash 已很少时，可用额度极低 | 中 |
| **3. 100 股最小单位** | 若 `available < 100*price` 则 quantity=0 直接失败；高价股需更多现金 | 高 |
| **4. 单股 max_position 与多股竞争** | max_position_size=0.2 时，10 只股都发买入信号理论上需 200% 资金，实际只有 100% | 高 |
| **5. 无资金预分配** | 每天所有买入信号共享现金池，谁先执行谁先拿 | 高 |
| **6. 无信号优先级** | 高 strength 信号可能排在后面，低价值信号先消耗资金 | 中 |

---

## 三、典型场景举例

### 场景 A：多股同天买入

- 初始资金 100 万，max_position_size=0.2
- 某日有 5 只股票发出买入信号
- 第 1 只：用掉约 20 万（20% 组合价值）
- 第 2 只：再用约 16 万（剩余 80 万的 20%）
- 第 3 只：再用约 12.8 万
- ...
- 第 5 只：现金可能已不足，或 `cash*0.95` 买不满 100 股 → **失败**

### 场景 B：持仓较多时新信号

- 已持有 8 只股票，总资产 120 万（持仓 100 万 + 现金 20 万）
- 新买入信号：该股理论额度 = 120 万 × 20% = 24 万
- 实际可用 = min(24 万, 20 万 × 0.95) = 19 万
- 若股票单价 500 元，19 万可买 380 股 → 可执行
- 若股票单价 2000 元，19 万只能买 95 股 → 向下取整 0 股 → **失败**

### 场景 C：topk_buffer 模式

- 初始建仓时 `n_buy = min(topk, len(to_buy))`，可能同一天要买 10 只
- 每只都通过 `portfolio_manager.execute_signal` 串行执行
- 第 1 只可能用掉可观现金，后续几只容易因资金不足失败

---

## 四、解决方案

### 方案 1：每日资金预分配（推荐）

**思路**：在同一天的多个买入信号执行前，先按比例预分配可用现金，避免"先到先得"导致后面的信号总是失败。

**实现要点**：
- 当日先收集所有 BUY 信号
- 计算总可用现金 `available = cash * 0.95`（或可配置）
- 按信号 strength 或等权分配：`per_signal = available / len(buy_signals)`
- 或在 `_execute_buy` 中增加可选参数 `allocated_cash`，限制该笔买入最多使用的现金

**代码位置**：`backtest_loop_executor.py` 中执行信号的循环前，或 `portfolio_manager._execute_buy` 增加分配逻辑。

---

### 方案 2：放宽 5% 现金保留（低风险）

**思路**：将 `cash * 0.95` 改为可配置，如 0.98 或 0.99，或在高持仓时动态放宽。

```python
# 当前
available_cash_for_stock = min(available_cash_for_stock, self.cash * 0.95)

# 改为可配置
reserve_ratio = getattr(self.config, 'cash_reserve_ratio', 0.95)
available_cash_for_stock = min(available_cash_for_stock, self.cash * (1 - reserve_ratio))
```

**配置**：在 `BacktestConfig` 中增加 `cash_reserve_ratio: float = 0.05`（保留 5%）。

---

### 方案 3：按 strength 排序 + 优先执行高价值信号（推荐）

**思路**：同一天的买入信号按 `strength` 降序排序，优先执行高价值信号，提高"好信号"的执行率。

```python
# 在 for signal in all_signals 之前
buy_signals = [s for s in all_signals if s.signal_type == SignalType.BUY]
sell_signals = [s for s in all_signals if s.signal_type == SignalType.SELL]
# 买入按 strength 降序
buy_signals.sort(key=lambda s: s.strength or 0, reverse=True)
all_signals = sell_signals + buy_signals  # 先卖后买
```

**位置**：`backtest_loop_executor.py` 中 `# ===== trade execution mode =====` 之后。

---

### 方案 4：支持不足 100 股时部分成交（需评估）

**思路**：若 100 股取整后 quantity=0，但 `available/price >= 1`，可考虑允许买入 100 股并由"动态补充资金"弥补缺口；或允许 1 股单位（需确认 A 股规则）。

**注意**：A 股最小交易单位一般为 100 股，此方案需结合交易所规则和业务需求。

---

### 方案 5：动态补充资金（已有设计文档）

**思路**：当 `total_cost > cash` 时，允许自动补充资金完成买入，补充资金算作成本。

**文档**：`docs/features/动态补充资金功能分析.md` 中已有完整设计与实现建议。

**适用**：更关注"宁可多花钱也要执行信号"的策略评估场景。

---

### 方案 6：调整 max_position_size 与资金分配策略

**思路**：
- 若策略同时持有股票数较多，可适当**降低** `max_position_size`（如从 0.2 到 0.1），让单笔买入占用更少现金，从而能执行更多笔
- 或增加 `max_positions_count`：限制同时持仓数量，避免资金过于分散

---

### 方案 7：topk_buffer 下的资金均匀建仓

**思路**：初始建仓时，对 `to_buy` 的每只股票**预计算**目标金额，确保总和不超过可用现金，再按目标金额执行买入，避免前几只占用过多资金。

```python
# 伪代码
available = portfolio_manager.cash * 0.95
per_stock = available / len(to_buy)
for code in to_buy:
    # 传入 allocated_cash=per_stock，限制单笔最多用 per_stock
    ...
```

**位置**：`_rebalance_topk_buffer` 中买入循环，需配合 `portfolio_manager._execute_buy` 支持 `allocated_cash` 参数。

---

## 五、不限制买入模式（已实现）

已通过 `enable_unlimited_buy` 配置实现「不限制买入」模式：

**启用方式**：在 `strategy_config` 中设置 `"enable_unlimited_buy": true`

**行为**：
1. 忽略单股 `max_position_size` 限制
2. 忽略 5% 现金保留，可用全部现金买入
3. 当现金不足时**自动补充资金**，确保买入信号执行
4. 补充资金计入 `total_capital_injection`，收益基准为 `initial_cash + total_capital_injection`

**成本与收益计算**（已实现）：
- **total_return**：分母为 `initial_cash + total_capital_injection`，分子为 `final_value - total_invested`
- **cost_statistics**：包含 `total_capital_injection`，`cost_ratio` 分母也为总投入
- **portfolio_history**：每日 `total_return` 统一用总投入作分母
- **多进程合并**：对各 worker 的 `total_capital_injection` 取平均后参与合并收益计算

**开启方式**：

1. **前端创建任务**：在「回测配置」卡片中打开「不限制买入」开关  
2. **前端优化任务**：在「优化配置」卡片中打开「不限制买入」开关（Optuna 参数搜索生效）  
3. **API 传参**：在 `strategy_config` 中设置 `"enable_unlimited_buy": true`  
4. **URL 参数**：`?enable_unlimited_buy=true`（用于重建任务/优化任务）

---

## 六、推荐实施顺序

| 优先级 | 方案 | 改动量 | 预期效果 |
|-------|------|--------|----------|
| P0 | 方案 3：按 strength 排序 | 小 | 提升高价值信号执行率 |
| P0 | 方案 2：现金保留可配置 | 小 | 略微释放可用资金 |
| P1 | 方案 1：每日资金预分配 | 中 | 显著提升多信号同天的执行率 |
| P1 | 方案 7：topk_buffer 均匀建仓 | 中 | 改善 topk 模式建仓执行率 |
| P2 | 方案 5：动态补充资金 | 大 | 可做到 100% 执行（有成本） |
| P2 | 方案 6：调整 max_position / max_positions | 配置级 | 从策略层面缓解资金紧张 |

---

## 七、快速验证建议

1. **统计未执行原因**：从 `signal_records` 表按 `execution_reason` 分组，确认"资金不足"、"可用资金不足"、"可买数量不足"各自占比。
2. **记录每日现金与信号数**：在回测循环中输出 `date, cash, len(buy_signals), executed_count`，观察现金与执行率关系。
3. **A/B 对比**：先用方案 3+2 做小改动，跑同样回测，对比执行率变化。

---

## 八、相关代码位置

| 模块 | 文件 | 关键方法/行 |
|-----|------|------------|
| 组合管理 | `portfolio_manager.py` | `_execute_buy` 134–178 |
| 回测循环 | `backtest_loop_executor.py` | 858–914 信号执行循环，814–842 topk_buffer |
| 配置 | `data_models.py` | `BacktestConfig.max_position_size` |
| 动态补充资金设计 | `docs/features/动态补充资金功能分析.md` | 完整方案 |
