# 回测统计表优化方案

## 问题分析

回测结果页面的信号记录页签打开太慢，主要原因是每次打开页面时都需要实时计算统计信息。当前实现中：

1. **信号统计** (`get_signal_statistics`): 需要执行5个COUNT查询和1个AVG查询
2. **交易统计** (`get_trade_statistics`): 需要执行多个COUNT、SUM、AVG查询
3. 当信号记录和交易记录数量很大时（如数万条），这些聚合查询会非常慢

## 优化方案

创建 `backtest_statistics` 表，在回测任务完成时预计算并存储所有统计信息，避免每次访问时实时计算。

## 需要存储的统计信息

### 1. 信号统计信息 (Signal Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `total_signals` | Integer | 总信号数 | COUNT(SignalRecord) |
| `buy_signals` | Integer | 买入信号数 | COUNT(SignalRecord WHERE signal_type='BUY') |
| `sell_signals` | Integer | 卖出信号数 | COUNT(SignalRecord WHERE signal_type='SELL') |
| `executed_signals` | Integer | 已执行信号数 | COUNT(SignalRecord WHERE executed=True) |
| `unexecuted_signals` | Integer | 未执行信号数 | total_signals - executed_signals |
| `execution_rate` | Float | 执行率 | executed_signals / total_signals |
| `avg_strength` | Float | 平均信号强度 | AVG(SignalRecord.strength) |

**当前实现位置**: `backend/app/repositories/backtest_detailed_repository.py:575-627`

### 2. 交易统计信息 (Trade Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `total_trades` | Integer | 总交易数 | COUNT(TradeRecord) |
| `buy_trades` | Integer | 买入交易数 | COUNT(TradeRecord WHERE action='BUY') |
| `sell_trades` | Integer | 卖出交易数 | COUNT(TradeRecord WHERE action='SELL') |
| `winning_trades` | Integer | 盈利交易数 | COUNT(TradeRecord WHERE pnl > 0) |
| `losing_trades` | Integer | 亏损交易数 | COUNT(TradeRecord WHERE pnl < 0) |
| `win_rate` | Float | 胜率 | winning_trades / total_trades |
| `avg_profit` | Float | 平均盈利 | AVG(TradeRecord.pnl WHERE pnl > 0) |
| `avg_loss` | Float | 平均亏损 | AVG(TradeRecord.pnl WHERE pnl < 0) |
| `profit_factor` | Float | 盈亏比 | abs(avg_profit / avg_loss) |
| `total_commission` | Float | 总手续费 | SUM(TradeRecord.commission) |
| `total_pnl` | Float | 总盈亏 | SUM(TradeRecord.pnl) |
| `avg_holding_days` | Float | 平均持仓天数 | AVG(TradeRecord.holding_days) |

**当前实现位置**: `backend/app/repositories/backtest_detailed_repository.py:323-409`

### 3. 持仓统计信息 (Position Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `total_stocks` | Integer | 总股票数 | COUNT(DISTINCT TradeRecord.stock_code) |
| `profitable_stocks` | Integer | 盈利股票数 | COUNT(DISTINCT stock_code WHERE total_pnl > 0) |
| `avg_stock_return` | Float | 平均股票收益率 | AVG(每只股票的总收益) |
| `max_stock_return` | Float | 最大股票收益率 | MAX(每只股票的总收益) |
| `min_stock_return` | Float | 最小股票收益率 | MIN(每只股票的总收益) |

**当前实现位置**: `frontend/src/components/backtest/PositionAnalysis.tsx:254-289` (前端计算，建议移到后端)

### 4. 时间范围统计 (Time Range Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `first_signal_date` | DateTime | 第一个信号日期 | MIN(SignalRecord.timestamp) |
| `last_signal_date` | DateTime | 最后一个信号日期 | MAX(SignalRecord.timestamp) |
| `first_trade_date` | DateTime | 第一笔交易日期 | MIN(TradeRecord.timestamp) |
| `last_trade_date` | DateTime | 最后一笔交易日期 | MAX(TradeRecord.timestamp) |
| `trading_days` | Integer | 交易天数 | COUNT(DISTINCT DATE(timestamp)) |

### 5. 股票分布统计 (Stock Distribution Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `unique_stocks_signaled` | Integer | 产生信号的股票数 | COUNT(DISTINCT SignalRecord.stock_code) |
| `unique_stocks_traded` | Integer | 实际交易的股票数 | COUNT(DISTINCT TradeRecord.stock_code) |
| `most_signaled_stock` | String | 信号最多的股票代码 | GROUP BY stock_code ORDER BY COUNT DESC LIMIT 1 |
| `most_traded_stock` | String | 交易最多的股票代码 | GROUP BY stock_code ORDER BY COUNT DESC LIMIT 1 |

### 6. 性能指标统计 (Performance Statistics)

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| `max_single_profit` | Float | 单笔最大盈利 | MAX(TradeRecord.pnl WHERE pnl > 0) |
| `max_single_loss` | Float | 单笔最大亏损 | MIN(TradeRecord.pnl WHERE pnl < 0) |
| `max_consecutive_wins` | Integer | 最大连续盈利次数 | 计算连续盈利交易数 |
| `max_consecutive_losses` | Integer | 最大连续亏损次数 | 计算连续亏损交易数 |
| `largest_position_size` | Float | 最大持仓金额 | MAX(quantity * price) |

## 数据库表设计

```python
class BacktestStatistics(Base):
    """回测统计信息表（预计算统计，加速页面加载）"""
    __tablename__ = "backtest_statistics"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    task_id = Column(String(50), nullable=False, unique=True, index=True)
    backtest_id = Column(String(50), nullable=False, index=True)
    
    # ========== 信号统计 ==========
    total_signals = Column(Integer, default=0)
    buy_signals = Column(Integer, default=0)
    sell_signals = Column(Integer, default=0)
    executed_signals = Column(Integer, default=0)
    unexecuted_signals = Column(Integer, default=0)
    execution_rate = Column(Float, default=0.0)
    avg_signal_strength = Column(Float, default=0.0)
    
    # ========== 交易统计 ==========
    total_trades = Column(Integer, default=0)
    buy_trades = Column(Integer, default=0)
    sell_trades = Column(Integer, default=0)
    winning_trades = Column(Integer, default=0)
    losing_trades = Column(Integer, default=0)
    win_rate = Column(Float, default=0.0)
    avg_profit = Column(Float, default=0.0)
    avg_loss = Column(Float, default=0.0)
    profit_factor = Column(Float, default=0.0)
    total_commission = Column(Float, default=0.0)
    total_pnl = Column(Float, default=0.0)
    avg_holding_days = Column(Float, default=0.0)
    
    # ========== 持仓统计 ==========
    total_stocks = Column(Integer, default=0)
    profitable_stocks = Column(Integer, default=0)
    avg_stock_return = Column(Float, default=0.0)
    max_stock_return = Column(Float, default=0.0)
    min_stock_return = Column(Float, default=0.0)
    
    # ========== 时间范围统计 ==========
    first_signal_date = Column(DateTime, nullable=True)
    last_signal_date = Column(DateTime, nullable=True)
    first_trade_date = Column(DateTime, nullable=True)
    last_trade_date = Column(DateTime, nullable=True)
    trading_days = Column(Integer, default=0)
    
    # ========== 股票分布统计 ==========
    unique_stocks_signaled = Column(Integer, default=0)
    unique_stocks_traded = Column(Integer, default=0)
    most_signaled_stock = Column(String(20), nullable=True)
    most_traded_stock = Column(String(20), nullable=True)
    
    # ========== 性能指标统计 ==========
    max_single_profit = Column(Float, nullable=True)
    max_single_loss = Column(Float, nullable=True)
    max_consecutive_wins = Column(Integer, default=0)
    max_consecutive_losses = Column(Integer, default=0)
    largest_position_size = Column(Float, nullable=True)
    
    # 元数据
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # 创建索引
    __table_args__ = (
        Index('idx_statistics_task_id', 'task_id', unique=True),
        Index('idx_statistics_backtest_id', 'backtest_id'),
    )
```

## 实现步骤

### 1. 创建数据库模型

在 `backend/app/models/backtest_detailed_models.py` 中添加 `BacktestStatistics` 模型。

### 2. 创建统计计算服务

创建 `backend/app/services/backtest/statistics/statistics_calculator.py`，实现统计信息的计算逻辑。

### 3. 在回测完成时计算并保存统计

在回测任务完成时（`backend/app/api/v1/dependencies.py` 的 `save_detailed_data` 函数中），调用统计计算服务并保存到数据库。

### 4. 修改Repository方法

修改 `BacktestDetailedRepository` 的 `get_signal_statistics` 和 `get_trade_statistics` 方法，优先从统计表读取，如果不存在则实时计算（向后兼容）。

### 5. 数据迁移脚本

创建迁移脚本，为现有回测任务计算并填充统计信息。

## 性能提升预期

- **当前**: 每次打开信号记录页签需要执行5-10个聚合查询，耗时1-5秒（取决于数据量）
- **优化后**: 直接从统计表读取，耗时 < 10ms
- **提升**: 预计提升 **100-500倍**

## 注意事项

1. **数据一致性**: 当信号记录或交易记录被修改时，需要同步更新统计表
2. **向后兼容**: 对于没有统计数据的旧任务，仍支持实时计算
3. **增量更新**: 如果支持增量添加信号/交易记录，需要实现增量统计更新逻辑

## 相关文件

- `backend/app/repositories/backtest_detailed_repository.py` - 当前统计查询实现
- `backend/app/api/v1/backtest_detailed.py` - API接口
- `frontend/src/components/backtest/SignalHistoryTable.tsx` - 前端信号记录组件
- `frontend/src/components/backtest/TradeHistoryTable.tsx` - 前端交易记录组件
- `backend/app/models/backtest_detailed_models.py` - 数据模型定义
