# 多策略组合回测系统 - 开发计划概览

## 🎯 核心目标

实现多策略组合回测系统，通过信号融合提升策略稳健性和收益潜力。

## 📅 时间规划

| 阶段 | 时间 | 主要任务 |
|------|------|---------|
| **阶段0** | 1-2天 | 准备与设计 |
| **阶段1** | 1-2周 | 核心功能实现（P0） |
| **阶段2** | 2-3周 | 功能增强和优化（P1） |
| **阶段3** | 持续 | 高级功能（P2） |

**总计（阶段0+1+2）**：约 **4-5周**

---

## 🏗️ 阶段1：核心功能（P0 - 必须实现）

### 1.1 信号整合器（SignalIntegrator）- 3-4天
- **文件**：`utils/signal_integrator.py`
- **功能**：加权投票、一致性增强、冲突解决
- **验收**：单元测试覆盖率 > 80%

### 1.2 策略组合类（StrategyPortfolio）- 3-4天
- **文件**：`core/strategy_portfolio.py`
- **功能**：管理多策略、继承BaseStrategy、信号整合
- **验收**：完全兼容现有接口

### 1.3 扩展策略工厂 - 2-3天
- **文件**：`strategies/strategy_factory.py`
- **功能**：支持创建组合策略、保持兼容
- **验收**：单策略功能不受影响

### 1.4 扩展回测API - 2-3天
- **文件**：`api/v1/backtest.py`
- **功能**：支持组合策略配置、API文档更新
- **验收**：API向后兼容

### 1.5 后端测试 - 2-3天
- **文件**：`tests/test_*.py`
- **功能**：单元测试、集成测试
- **验收**：覆盖率 > 80%，所有测试通过

### 1.6 前端组合策略配置组件 - 4-5天
- **文件**：`frontend/src/components/backtest/PortfolioStrategyConfig.tsx`
- **功能**：策略组合配置界面、权重配置、参数配置
- **验收**：UI流畅，配置正确

### 1.7 前端组合策略结果展示 - 3-4天
- **文件**：`frontend/src/components/backtest/PortfolioStrategyResults.tsx`
- **功能**：策略贡献度可视化、权重分布图表
- **验收**：结果展示正确，图表清晰

---

## 🚀 阶段2：功能增强（P1 - 重要功能）

### 2.1 策略贡献度分析 - 3-4天
- 分析各策略收益贡献
- 计算策略相关性
- 识别冗余策略

### 2.2 动态权重调整 - 4-5天
- 基于策略表现调整权重
- 平滑机制防止剧烈波动

### 2.3 市场状态感知 - 5-6天
- 检测市场状态（趋势/震荡/波动）
- 根据状态选择策略组合

### 2.4 性能优化 - 3-4天
- 并行化信号生成
- 指标计算共享
- 向量化优化

---

## ✅ 工程验收标准（确定性测试）

### 1. 组合权重约束验证
- ✅ **权重归一化**：所有权重之和 = 1.0（误差 < 0.001）
- ✅ **最大权重限制**：单策略权重 <= max_weight（默认0.5）
- ✅ **总杠杆限制**：gross_leverage <= 配置值（默认1.0）
- ✅ **权重非负**：所有权重 >= 0

### 2. 策略权重 meta-weight 生效验证
- ✅ 策略级权重正确应用到信号融合
- ✅ 权重配置在回测过程中保持不变

### 3. 调仓频率正确性验证
- ✅ 按照配置的频率（daily/weekly/monthly）执行调仓
- ✅ 信号生成频率与调仓频率一致

### 4. 缺失处理正确性验证
- ✅ 策略信号缺失时不影响其他策略
- ✅ 数据缺失时优雅降级
- ✅ 部分策略失效时权重自动归一化

### 5. 与单策略结果一致性验证
- ✅ 组合只含1个策略且权重=1时，结果与单策略完全一致
- ✅ 收益、夏普比率等指标误差 < 0.0001
- ✅ 交易记录（时间、价格、数量）完全一致

---

## 📋 配置示例

### 组合策略配置格式

```json
{
  "strategy_name": "portfolio",
  "strategy_config": {
    "strategies": [
      {
        "name": "rsi",
        "weight": 0.4,
        "config": {"rsi_period": 14}
      },
      {
        "name": "macd",
        "weight": 0.3,
        "config": {"fast_period": 12}
      },
      {
        "name": "bollinger",
        "weight": 0.3,
        "config": {"period": 20}
      }
    ],
    "integration_method": "weighted_voting"
  }
}
```

---

## ✅ 里程碑

### 里程碑1：MVP完成（阶段1结束）
- ✅ 基础组合策略功能可用
- ✅ 信号融合算法实现
- ✅ API支持组合策略
- ✅ 基础测试通过

**验证**：组合策略效果优于单策略（至少一个测试用例）

### 里程碑2：功能完整（阶段2结束）
- ✅ 策略贡献度分析可用
- ✅ 动态权重调整可用
- ✅ 市场状态感知可用
- ✅ 性能优化完成

**验证**：组合策略在多个测试用例中表现优于单策略

---

## ⚠️ 关键风险

| 风险 | 应对措施 |
|------|---------|
| 信号融合算法效果不佳 | 先实现简单算法验证，再优化 |
| 与现有架构不兼容 | 严格遵循BaseStrategy接口，充分测试 |
| 性能问题 | 阶段2包含性能优化 |
| 组合策略效果不如预期 | 阶段1快速验证，及时调整方向 |

---

## 🎯 快速启动

### 第一步：快速验证（1-2天）
1. 实现最简单的加权投票算法
2. 手动创建2-3个策略的组合
3. 运行回测验证效果

### 第二步：完善框架（阶段1）
如果验证通过，继续完善框架和API

### 第三步：持续优化（阶段2+）
根据实际使用情况持续优化

---

## 📝 验收标准

### 功能验收
- [ ] 能够通过前端创建并运行组合策略回测
- [ ] 信号融合算法正确工作
- [ ] 策略贡献度分析准确
- [ ] 动态权重调整有效
- [ ] 前端配置界面流畅易用

### 工程验收（确定性测试）
- [ ] 组合权重符合约束（归一、max_weight、gross_leverage）
- [ ] 策略权重 meta-weight 生效
- [ ] 调仓频率正确
- [ ] 缺失处理正确
- [ ] 与单策略结果一致性（组合只含1个策略且权重=1时，结果与单策略完全一致/误差在阈值内）

### 质量验收
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 原有单策略功能完全不受影响
- [ ] 原有API完全兼容

---

## 📌 注意事项

1. **保持兼容性**：所有改动必须保持向后兼容
2. **渐进式开发**：先实现核心功能，快速验证假设
3. **充分测试**：每个阶段都要有充分的测试
4. **文档同步**：代码和文档同步更新

---

**详细计划**：请查看 `MULTI_STRATEGY_DEVELOPMENT_PLAN.md`
