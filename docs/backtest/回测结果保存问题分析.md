# 回测结果保存问题分析报告

## 问题描述

回测任务完成后，查询回测详细结果时返回404错误，提示"未找到回测详细结果"。

## 根本原因

通过日志分析发现，问题出在保存回测详细数据到数据库的过程中：

### 1. JSON序列化错误
**错误信息**：`Object of type float32 is not JSON serializable`

**原因**：
- 回测计算过程中使用了numpy库，产生的数值类型为 `numpy.float32`、`numpy.float64`、`numpy.int32`、`numpy.int64` 等
- 这些numpy类型无法直接被JSON序列化
- SQLAlchemy在保存JSON字段时需要进行JSON序列化，因此抛出异常

### 2. 事务回滚连锁反应
**错误流程**：
1. 创建 `BacktestDetailedResult` 记录时失败（JSON序列化错误）
2. 数据库事务被回滚
3. 后续的保存操作（组合快照、交易记录）都因为事务已回滚而失败
4. 最终导致整个回测详细数据保存失败

### 3. 错误日志位置
- 日志文件：`data/logs/backend.log`
- 关键错误行：1029, 1033, 1038, 1080

## 解决方案

### 修复内容

在 `backend/app/api/v1/dependencies.py` 的 `execute_backtest_task_simple` 函数中：

1. **添加类型转换辅助函数**：
   ```python
   def to_python_type(value):
       """将numpy类型转换为Python原生类型"""
       import numpy as np
       if isinstance(value, (np.integer, np.floating)):
           return value.item()
       elif isinstance(value, np.ndarray):
           return value.tolist()
       elif isinstance(value, dict):
           return {k: to_python_type(v) for k, v in value.items()}
       elif isinstance(value, (list, tuple)):
           return [to_python_type(v) for v in value]
       return value
   ```

2. **转换扩展指标数据**：
   - `sortino_ratio`
   - `calmar_ratio`
   - `max_drawdown_duration`
   - `var_95`
   - `downside_deviation`

3. **转换分析数据**：
   - `drawdown_analysis`
   - `monthly_returns`
   - `position_analysis`
   - `benchmark_comparison`

4. **转换组合快照数据**：
   - `portfolio_value`
   - `cash`
   - `positions_count`
   - `total_return`
   - `positions`

5. **转换交易记录数据**：
   - `quantity`
   - `price`
   - `commission`
   - `pnl`
   - `holding_days`

## 修复效果

修复后，所有numpy类型都会被转换为Python原生类型（`float`、`int`），确保：
- JSON序列化可以正常进行
- 数据库保存操作成功
- 回测详细结果可以正常查询

## 验证方法

1. 运行一个新的回测任务
2. 等待任务完成
3. 查询回测详细结果：`GET /api/v1/backtest-detailed/{task_id}/detailed-result`
4. 应该能够成功返回详细结果数据

## 相关文件

- `backend/app/api/v1/dependencies.py` - 修复的主要文件
- `backend/app/repositories/backtest_detailed_repository.py` - 数据仓库层
- `backend/app/models/backtest_detailed_models.py` - 数据模型定义

## 第二个问题：事务提交时机

### 问题描述

即使修复了JSON序列化问题，在某些情况下仍然查询不到数据。原因是：
- 统计信息计算耗时较长（约1分钟）
- 统计信息计算在主数据保存的同一个事务中
- 在事务未提交前，其他查询无法看到未提交的数据

### 解决方案

将事务分为两个阶段：
1. **第一阶段**：保存主数据（详细结果、组合快照、交易记录）后立即提交
2. **第二阶段**：在单独的事务中计算统计信息，不阻塞主数据查询

这样即使统计信息计算失败或耗时很长，主数据也可以立即查询到。

## 注意事项

1. 此修复确保了所有numpy类型都会被递归转换，包括嵌套的字典和列表
2. 如果将来添加新的字段，也需要确保进行类型转换
3. 建议在数据适配器层（`BacktestDataAdapter`）统一处理类型转换，避免在多个地方重复代码
4. 主数据和统计信息现在在分离的事务中保存，确保主数据立即可查询
