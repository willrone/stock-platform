---
marp: true
theme: default
paginate: true
header: '量化交易回测平台使用指南'
footer: '© 2026 回测平台'
style: |
  section {
    font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  h1 {
    color: #fff;
    border-bottom: 3px solid #fff;
    padding-bottom: 10px;
  }
  h2 {
    color: #ffd700;
  }
  code {
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 3px;
  }
---

<!-- _class: lead -->
# 量化交易回测平台
## 使用指南与策略详解

**完整回测流程 | 策略详解 | 实战案例**

---

## 目录

1. **平台概述** - 平台介绍与核心优势
2. **回测流程** - 6大阶段详细解析
3. **策略详解** - 10+种策略完整说明
4. **使用方法** - 从创建到结果分析
5. **实战案例** - 真实回测场景
6. **最佳实践** - 策略选择与优化建议

---

## 平台概述

### 平台定位
- **专业量化交易回测平台**
- 支持多策略、实时监控、组合配置
- 提供完整的收益与风险分析

### 技术架构
```
前端: Next.js + React + TypeScript
后端: FastAPI + SQLAlchemy + WebSocket
数据库: PostgreSQL
```

### 核心优势
✅ **多策略支持** - 技术分析、统计套利、因子投资  
✅ **实时监控** - WebSocket实时推送进度  
✅ **组合策略** - 灵活配置多策略权重  
✅ **性能优化** - 并行计算，提升速度  
✅ **数据完整** - 支持多种指标和因子

---

## 回测流程 - 整体架构

```
用户提交回测任务
    ↓
创建任务记录 (状态: CREATED, 进度: 0%)
    ↓
加入后台执行队列
    ↓
【6大执行阶段】
    ↓
保存结果，任务完成
```

---

## 阶段1: 初始化 (0-10%)

### 主要任务
- ✅ 生成唯一回测ID
- ✅ 启动进度监控服务
- ✅ 建立WebSocket连接
- ✅ 初始化回测环境

### 关键代码
```python
backtest_id = f"bt_{timestamp}_{hash(stock_codes)}"
await backtest_progress_monitor.start_backtest_monitoring(
    task_id=task_id,
    backtest_id=backtest_id
)
```

---

## 阶段2: 数据加载 (10-25%)

### 数据来源
- 从 `backend/data/` 目录加载CSV文件
- 使用 `StockDataLoader` 统一加载器
- **支持并行加载** (股票数>3时自动启用)

### 数据验证
- ✅ 检查必需列: `open`, `high`, `low`, `close`, `volume`
- ✅ 验证数据量 (至少20个交易日)
- ✅ 检查数据完整性

### 性能优化
- 多股票并行加载
- 内存优化处理
- 数据缓存机制

---

## 阶段3: 策略设置 (25-30%)

### 策略创建
```python
strategy = StrategyFactory.create_strategy(
    strategy_name="moving_average",
    config={
        "short_window": 5,
        "long_window": 20
    }
)
```

### 组合管理器初始化
- **初始资金**: 默认100,000元
- **手续费率**: 默认0.03% (0.0003)
- **滑点率**: 默认0.01% (0.0001)
- **持仓管理**: 自动跟踪持仓和资金

---

## 阶段4: 回测执行 (30-90%) - 核心阶段

### 逐日回测循环

```python
for current_date in trading_dates:
    # 1. 获取当前价格
    current_prices = get_current_prices()
    
    # 2. 生成交易信号
    signals = strategy.generate_signals(historical_data)
    
    # 3. 验证并执行信号
    trades = execute_signals(signals)
    
    # 4. 更新持仓和资金
    update_portfolio(current_prices)
    
    # 5. 记录交易历史
    record_trades(trades)
    
    # 6. 更新进度
    update_progress(progress)
```

---

## 阶段5: 结果计算 (90-95%)

### 收益率指标
- **总收益率**: 回测期间总收益
- **年化收益率**: 年化后的收益
- **夏普比率**: 风险调整后收益

### 风险指标
- **最大回撤**: 最大亏损幅度
- **波动率**: 收益波动程度
- **VaR**: 风险价值

### 交易统计
- **交易次数**: 总买卖次数
- **胜率**: 盈利交易占比
- **平均持仓时间**: 持仓周期

---

## 阶段6: 完成 (95-100%)

### 最终处理
- ✅ 保存回测结果到数据库
- ✅ 更新任务状态为 `COMPLETED`
- ✅ 通过WebSocket推送完成通知
- ✅ 生成回测报告

### 结果输出
- 收益曲线图表
- 持仓分析报告
- 交易历史记录
- 风险分析报告

---

## 策略分类总览

### 三大策略类别

1. **技术分析策略** (6种)
   - 移动平均、RSI、MACD
   - 布林带、随机指标、CCI

2. **统计套利策略** (3种)
   - 配对交易、均值回归、协整

3. **因子投资策略** (4种)
   - 价值因子、动量因子、低波动、多因子

---

## 基础策略1: 移动平均策略

### 策略原理
- **金叉**: 短期均线上穿长期均线 → **买入信号**
- **死叉**: 短期均线下穿长期均线 → **卖出信号**

### 关键参数
```python
{
    "short_window": 5,      # 短期均线周期
    "long_window": 20,      # 长期均线周期
    "signal_threshold": 0.02 # 信号阈值
}
```

### 适用场景
- ✅ 趋势明显的市场
- ✅ 中长期持仓
- ✅ 波动较大的股票

---

## 基础策略2: RSI策略

### 策略原理
- **RSI < 30**: 超卖区域 → 可能反弹
- **RSI > 70**: 超买区域 → 可能回调
- **核心特性**: 趋势对齐 + 背离检测 + 穿越信号

### 关键参数
```python
{
    "rsi_period": 14,
    "oversold_threshold": 30,
    "overbought_threshold": 70,
    "enable_trend_alignment": True,
    "enable_divergence": True
}
```

### 适用场景
- ✅ 震荡市场
- ✅ 短期交易
- ✅ 波动适中的股票

---

## 基础策略3: MACD策略

### 策略原理
- **MACD金叉**: MACD线上穿信号线 → **买入信号**
- **MACD死叉**: MACD线下穿信号线 → **卖出信号**

### 关键参数
```python
{
    "fast_period": 12,    # 快速EMA周期
    "slow_period": 26,    # 慢速EMA周期
    "signal_period": 9    # 信号线周期
}
```

### 适用场景
- ✅ 趋势跟踪
- ✅ 中长期持仓
- ✅ 趋势明显的股票

---

## 高级策略1: 布林带策略

### 策略原理
- **价格突破下轨**: 可能反弹 → **买入信号**
- **价格突破上轨**: 可能回调 → **卖出信号**

### 关键参数
```python
{
    "period": 20,          # 均线周期
    "std_dev": 2,         # 标准差倍数
    "entry_threshold": 0.02 # 入场阈值
}
```

### 适用场景
- ✅ 震荡市场
- ✅ 均值回归交易
- ✅ 波动较大的股票

---

## 高级策略2: 配对交易策略

### 策略原理
1. 寻找相关性高的股票对
2. 价差偏离均值时交易
3. 等待价差回归均值时平仓

### 关键参数
```python
{
    "correlation_threshold": 0.8,
    "zscore_threshold": 2.0,
    "entry_threshold": 2.0,
    "exit_threshold": 0.5
}
```

### 适用场景
- ✅ 需要选择相关性高的股票对
- ✅ 适合波动较小的市场
- ✅ 适合长期持仓

---

## 因子投资策略

### 价值因子策略
- **原理**: 基于估值指标选择股票
- **指标**: PE、PB、PS等
- **适用**: 长期投资，价值投资理念

### 动量因子策略
- **原理**: 基于价格动量选择股票
- **指标**: 收益率、相对强度
- **适用**: 趋势明显的市场

### 低波动因子策略
- **原理**: 选择波动率低的股票
- **指标**: 历史波动率
- **适用**: 风险厌恶型投资者

---

## 组合策略

### 策略组合原理
- 将多个策略组合使用
- 通过权重分配控制各策略影响
- 使用信号整合方法合并信号

### 信号整合方法

**1. 加权投票 (weighted_voting)**
```python
final_signal = sum(signal * weight for signal, weight in strategies.items())
```

**2. 多数投票 (majority_voting)**
```python
final_signal = majority(signals)
```

**3. 加权平均 (weighted_average)**
```python
final_signal = weighted_average(signals, weights)
```

---

## 组合策略配置示例

```json
{
    "strategy_name": "portfolio",
    "strategy_config": {
        "strategies": [
            {
                "name": "rsi",
                "weight": 0.4,
                "config": {"rsi_period": 14}
            },
            {
                "name": "macd",
                "weight": 0.3,
                "config": {"fast_period": 12}
            },
            {
                "name": "bollinger",
                "weight": 0.3,
                "config": {"period": 20}
            }
        ],
        "integration_method": "weighted_voting"
    }
}
```

---

## 使用方法 - 创建回测任务

### 步骤1: 访问任务创建页面
- 导航到: `/tasks/create`
- 选择任务类型: **回测**

### 步骤2: 配置基本参数
```typescript
{
    task_name: "我的回测任务",
    start_date: "2024-01-01",
    end_date: "2024-12-31",
    initial_cash: 100000,
    commission_rate: 0.0003,
    slippage_rate: 0.0001
}
```

### 步骤3: 选择股票和策略
- 点击"选择股票"按钮
- 选择策略类型 (单策略/组合策略)
- 配置策略参数

---

## 使用方法 - 监控回测进度

### 实时进度监控
- **WebSocket连接**: 自动建立连接
- **进度更新**: 实时显示 (0-100%)
- **阶段信息**: 显示当前执行阶段

### 进度阶段
```
初始化 (0-10%)      → 生成回测ID
数据加载 (10-25%)   → 加载股票数据
策略设置 (25-30%)   → 创建策略实例
回测执行 (30-90%)   → 逐日回测循环
结果计算 (90-95%)   → 计算指标
完成 (95-100%)      → 保存结果
```

---

## 使用方法 - 查看回测结果

### 结果概览
- **总收益率**: 回测期间总收益
- **年化收益率**: 年化后的收益
- **夏普比率**: 风险调整后收益
- **最大回撤**: 最大亏损幅度
- **交易次数**: 总交易次数
- **胜率**: 盈利交易占比

### 详细分析
1. **收益曲线** - 资产净值曲线
2. **持仓分析** - 持仓分布和时间
3. **交易历史** - 所有交易记录
4. **风险分析** - 波动率和VaR
5. **信号历史** - 所有交易信号

---

## 实战案例1: 移动平均策略

### 场景配置
- **股票**: 000001 (平安银行)
- **时间范围**: 2024-01-01 至 2024-12-31
- **初始资金**: 100,000元
- **策略**: 移动平均 (短期5日，长期20日)

### 配置示例
```json
{
    "strategy_name": "moving_average",
    "strategy_config": {
        "short_window": 5,
        "long_window": 20,
        "signal_threshold": 0.02
    },
    "stock_codes": ["000001"],
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
}
```

### 预期结果
- 在趋势明显的时期产生交易信号
- 金叉时买入，死叉时卖出
- 适合中长期持仓

---

## 实战案例2: RSI策略

### 场景配置
- **股票**: 000002 (万科A)
- **时间范围**: 2024-01-01 至 2024-12-31
- **初始资金**: 100,000元
- **策略**: RSI (周期14，超卖30，超买70)

### 配置示例
```json
{
    "strategy_name": "rsi",
    "strategy_config": {
        "rsi_period": 14,
        "oversold_threshold": 30,
        "overbought_threshold": 70,
        "enable_trend_alignment": true
    },
    "stock_codes": ["000002"]
}
```

### 预期结果
- 在震荡市场产生较多交易信号
- 结合趋势对齐，提高信号质量
- 适合短期交易

---

## 实战案例3: 组合策略

### 场景配置
- **股票**: 000001, 000002, 000858
- **时间范围**: 2024-01-01 至 2024-12-31
- **初始资金**: 100,000元
- **策略**: RSI + MACD + 布林带组合

### 配置示例
```json
{
    "strategy_name": "portfolio",
    "strategy_config": {
        "strategies": [
            {"name": "rsi", "weight": 0.4},
            {"name": "macd", "weight": 0.3},
            {"name": "bollinger", "weight": 0.3}
        ],
        "integration_method": "weighted_voting"
    }
}
```

### 预期结果
- 综合多个策略的信号
- 降低单一策略的风险
- 提高策略稳定性

---

## 最佳实践 - 策略选择

### 趋势市场
- **推荐**: 移动平均策略、MACD策略
- **特点**: 适合中长期持仓
- **参数**: 长期均线周期可适当延长

### 震荡市场
- **推荐**: RSI策略、布林带策略、均值回归策略
- **特点**: 适合短期交易
- **参数**: 调整超买超卖阈值

### 多股票组合
- **推荐**: 因子投资策略、组合策略
- **特点**: 分散风险，提高稳定性
- **参数**: 合理分配策略权重

---

## 最佳实践 - 参数调优

### 移动平均策略
- **短期均线**: 5-10日 (适合短期交易)
- **长期均线**: 20-60日 (适合中长期持仓)
- **阈值**: 根据股票波动率调整

### RSI策略
- **RSI周期**: 14日 (标准设置)
- **超卖/超买**: 30/70 或 20/80
- **特性**: 启用趋势对齐和背离检测

### MACD策略
- **快速/慢速**: 12/26 (标准设置)
- **信号线**: 9 (标准设置)
- **适用**: 趋势明显的股票

---

## 最佳实践 - 风险控制

### 仓位管理
- ✅ 单股持仓不超过30%
- ✅ 总持仓不超过100%
- ✅ 设置止损和止盈

### 交易成本
- ✅ 考虑手续费和滑点
- ✅ 避免频繁交易
- ✅ 选择流动性好的股票

### 回测验证
- ✅ 使用足够长的历史数据 (至少1年)
- ✅ 在不同市场环境下测试
- ✅ 对比多个策略的表现

---

## 常见问题解答

### Q: 为什么回测结果和实盘差异大?
**A**: 
- 回测使用历史数据，实盘面临未来不确定性
- 回测假设可以按收盘价成交，实盘可能有滑点
- 回测没有考虑市场冲击和流动性问题

### Q: 如何选择合适的策略?
**A**:
- 根据市场环境选择 (趋势 vs 震荡)
- 根据投资周期选择 (短期 vs 长期)
- 根据风险偏好选择 (激进 vs 保守)

### Q: 组合策略如何分配权重?
**A**:
- 根据策略历史表现分配
- 根据策略相关性分配 (低相关性策略可以增加权重)
- 使用优化工具自动寻找最优权重

---

## 平台核心价值

### 核心功能
1. **多策略支持** - 涵盖技术分析、统计套利、因子投资
2. **实时监控** - WebSocket实时推送进度和结果
3. **灵活配置** - 支持单策略和组合策略
4. **完整分析** - 提供详细的收益和风险分析

### 使用建议
1. **从简单开始** - 先使用基础策略 (如移动平均)
2. **逐步优化** - 根据回测结果调整参数
3. **组合使用** - 尝试组合多个策略降低风险
4. **持续学习** - 理解策略原理，不断改进

---

## 总结

### 平台优势
✅ **专业** - 完整的回测流程和策略体系  
✅ **实时** - WebSocket实时监控进度  
✅ **灵活** - 支持单策略和组合策略  
✅ **完整** - 详细的收益和风险分析

### 下一步行动
- 🚀 尝试不同的策略组合
- 📊 优化策略参数
- 📈 分析回测结果，改进策略
- ⚠️ 准备实盘交易 (谨慎!)

---

<!-- _class: lead -->
# 谢谢观看！

## 祝您回测顺利，交易成功！

**如有问题，欢迎咨询**
