# 交互式图表数据流说明

## 数据来源

交互式图表的数据来自以下几个数据库表：

### 1. `backtest_detailed_results` 表
存储回测的详细分析数据，包括：
- `drawdown_analysis`: 回撤分析数据（用于绘制回撤曲线）
- `monthly_returns`: 月度收益数据（用于绘制月度热力图）
- `position_analysis`: 持仓分析数据
- `benchmark_comparison`: 基准对比数据
- 扩展风险指标（Sortino比率、Calmar比率等）

### 2. `portfolio_snapshots` 表
存储组合历史快照数据，包括：
- `snapshot_date`: 快照日期
- `portfolio_value`: 组合总价值
- `total_return`: 累计收益率
- `drawdown`: 回撤幅度
- `positions`: 持仓详情

用于绘制**权益曲线图表**。

### 3. `backtest_chart_cache` 表
缓存已生成的图表数据，提高加载速度。

## 数据流程

### 回测任务执行流程

1. **任务执行** (`BacktestTaskExecutor.execute`)
   - 执行回测策略
   - 生成基本回测报告
   - 保存基本结果到 `tasks.result` 字段

2. **详细数据保存** (`save_detailed_data`)
   - 调用 `BacktestDataAdapter.adapt_backtest_result()` 转换数据
   - 保存到 `backtest_detailed_results` 表
   - 保存到 `portfolio_snapshots` 表
   - 保存交易记录到 `trade_records` 表

3. **图表数据生成**（前端请求时）
   - 前端调用 `/api/v1/backtest-detailed/{task_id}/cached-chart/{chart_type}`
   - 如果缓存不存在，从详细数据生成图表数据
   - 生成后缓存到 `backtest_chart_cache` 表

## 为什么获取不到数据？

### 问题原因

1. **详细数据未保存**
   - 回测任务完成后，只保存了基本结果到 `tasks.result`
   - `save_detailed_data()` 函数可能没有被调用，或者调用失败
   - 导致 `backtest_detailed_results` 和 `portfolio_snapshots` 表为空

2. **缓存服务错误**（已修复）
   - 之前缓存服务使用了错误的会话管理方式
   - 导致缓存操作失败

### 解决方案

#### 方案1：手动填充数据（适用于已有任务）

使用 `fill_backtest_details.py` 脚本填充已有任务的详细数据：

```bash
python fill_backtest_details.py <task_id>
```

#### 方案2：确保新任务自动保存（推荐）

检查 `backend/app/api/v1/dependencies.py` 中的 `execute_backtest_task_simple` 函数，确保：
1. `save_detailed_data()` 函数被正确调用
2. 错误被正确捕获和记录
3. 数据保存成功

#### 方案3：从现有回测数据生成图表（临时方案）

前端代码已经实现了从 `tasks.result` 中的 `portfolio_history` 生成图表数据的备用方案，但功能有限。

## 数据检查

### 检查详细数据是否存在

```sql
-- 检查详细结果
SELECT * FROM backtest_detailed_results WHERE task_id = 'your-task-id';

-- 检查组合快照
SELECT COUNT(*) FROM portfolio_snapshots WHERE task_id = 'your-task-id';

-- 检查任务基本结果
SELECT task_id, status, result FROM tasks WHERE task_id = 'your-task-id';
```

### 检查缓存数据

```sql
SELECT * FROM backtest_chart_cache WHERE task_id = 'your-task-id';
```

## 修复内容

1. ✅ 修复了缓存服务的会话管理问题
2. ✅ 改进了前端错误处理，允许部分图表数据加载失败
3. ✅ 添加了从现有回测数据生成图表的备用方案

## 下一步

1. 检查回测任务执行完成后是否正确调用 `save_detailed_data()`
2. 对于已有任务，使用 `fill_backtest_details.py` 填充数据
3. 确保新任务自动保存详细数据

